---
layout:     post
title:      android watchdog学习
subtitle:   android watchdog 看门狗学习记录
date:       2018-04-05
author:     duguma
header-img: img/article-bg.jpg
top: false
catalog: true
tags:
    - Android
    - 工具命令
---  

 <article class="baidu_pl">
      
<p>我们都知道&#xff0c;当应用超过一定时间无响应的时候&#xff0c;系统为了不让应用长时处于不可操作的状态&#xff0c;会弹出一个“无响应”&#xff08;ANR&#xff09;的对话框&#xff0c;用户可以选择强制关闭&#xff0c;从而关掉这个进程。</p> 
<p>ANR机制是针对应用的&#xff0c;对于系统进程来说&#xff0c;如果长时间“无响应”&#xff0c;Android系统设计了WatchDog机制来管控。如果超过了“无响应”的延时&#xff0c;那么系统WatchDog会触发自杀机制。</p> 
<p>当我们分析死机重启问题LOG的时候&#xff0c;经常会看到下面这样一句话&#xff1a;</p> 
<pre><code>*** WATCHDOG KILLING SYSTEM PROCESS:
</code></pre> 
<p>从字面意思上看是&#xff1a;看门狗杀掉了系统进程。这里就提到了本文将要分析的WatchDog机制&#xff0c;对于WatchDog机制来说&#xff0c;主要通过添加两种类型的Checker&#xff0c;然后每隔30s去检测一次是否有死锁和线程池堵塞的情况&#xff0c;如果存在&#xff0c;则kill掉系统。Checker主要是如下两类&#xff1a;</p> 
<ul><li>MonitorChecker 检查系统核心服务是否被锁时间过长。</li><li>HandlerChecker 检查系统核心线程创建的Looper管理的消息队列是否阻塞。实际上&#xff0c;MonitorChecker也是一种线程是FgThread的HandlerChecker。</li></ul> 
<blockquote> 
 <p><font color="#ff0000"> 为了方便描述&#xff0c;本文所指HandlerChecker不包括线程是FgThread的MonitorChecker。</font></p> 
</blockquote> 
<p>接下来我们将从以下几个方面对Watchdog机制展开分析&#xff1a;、</p> 
<ol><li>Watchdog、MonitorChecker 、Handlerchecker初始化。</li><li>Watchdog 机制原理分析。</li><li>Watchdog死机重启问题分析方法。</li></ol> 
<h1><a id="Watchdog__25"></a>Watchdog 启动</h1> 
<p>Watchdog是一个线程&#xff0c;继承于Thread&#xff0c;在SystemServer.java里面通过getInstance获取watchdog的对象。</p> 
<p>&#64;SystemServer.java</p> 
<pre><code>            final Watchdog watchdog &#61; Watchdog.getInstance();
            watchdog.init(context, mActivityManagerService);

</code></pre> 
<p>在<code>init</code>方法里面&#xff0c;注册了<code>ACTION_REBOOT</code>的广播接收器。</p> 
<pre><code>    public void init(Context context, ActivityManagerService activity) {

        context.registerReceiver(new RebootRequestReceiver(),
                new IntentFilter(Intent.ACTION_REBOOT),
                android.Manifest.permission.REBOOT, null);
    }
</code></pre> 
<h2><a id="HandlerChecker_46"></a>初始化HandlerChecker</h2> 
<p>在Watchdog初始化的过程中&#xff0c;会初始化<code>Handlerchecker</code>&#xff0c;代码如下&#xff1a;</p> 
<pre><code>        HandlerChecker(Handler handler, String name, long waitMaxMillis) {
            mHandler &#61; handler;
            mName &#61; name;
            mWaitMax &#61; waitMaxMillis;
            mCompleted &#61; true;
        }
</code></pre> 
<p>参数分别表示:</p> 
<ul><li>handler: 观察的Handler.</li><li>name: 对Handler对应的线程名字命名,主要方便后续发生异常之后&#xff0c;在LOG中输出对应的线程名。</li><li>waitMaxMillis&#xff1a; 消息队列阻塞的最大时长&#xff0c;超过这个时长&#xff0c;就会Kill系统&#xff0c;默认是60s。</li></ul> 
<p>watchdog的构造方法里面&#xff0c;会初始化名字分别是<code>foreground thread</code>&#xff0c;<code>main thread</code>&#xff0c;<code>ui thread</code>&#xff0c;<code>i/o thread</code>&#xff0c;<code>display thread</code>的HandlerChecker&#xff08;FgThread特例&#xff09;&#xff0c;默认的DEFAULT_TIMEOUT是60s&#xff0c;也就是说&#xff0c;线程创建的Looper里面的消息队列不能阻塞超过60s。</p> 
<p>代码如下&#xff1a;</p> 
<pre><code>    private Watchdog() {
        super(&#34;watchdog&#34;);

        mMonitorChecker &#61; new HandlerChecker(FgThread.getHandler(),
                &#34;foreground thread&#34;, DEFAULT_TIMEOUT);
        mHandlerCheckers.add(mMonitorChecker);
        // Add checker for main thread.  We only do a quick check since there
        // can be UI running on the thread.
        mHandlerCheckers.add(new HandlerChecker(new Handler(Looper.getMainLooper()),
                &#34;main thread&#34;, DEFAULT_TIMEOUT));
        // Add checker for shared UI thread.
        mHandlerCheckers.add(new HandlerChecker(UiThread.getHandler(),
                &#34;ui thread&#34;, DEFAULT_TIMEOUT));
        // And also check IO thread.
        mHandlerCheckers.add(new HandlerChecker(IoThread.getHandler(),
                &#34;i/o thread&#34;, DEFAULT_TIMEOUT));
        // And the display thread.
        mHandlerCheckers.add(new HandlerChecker(DisplayThread.getHandler(),
                &#34;display thread&#34;, DEFAULT_TIMEOUT));

        // Initialize monitor for Binder threads.
        addMonitor(new BinderThreadMonitor());
    }
</code></pre> 
<h2><a id="MonitorChecker_94"></a>初始化MonitorChecker</h2> 
<p>如上代码&#xff0c;在初始化Watchdog的过程中&#xff0c;会添加BinderThreadMonitor。</p> 
<pre><code class="prism language-java">     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BinderThreadMonitor</span> <span class="token keyword">implements</span> <span class="token class-name">Watchdog<span class="token punctuation">.</span>Monitor</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">&#64;Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Binder<span class="token punctuation">.</span><span class="token function">blockUntilThreadAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_109"></a>外部添加</h2> 
<p>除了WatchDog里面自己添加的固定的Checker之外&#xff0c;Watchdog还提供了两个方法<code>addMonitor</code>和<code>addThread</code>供外部添加HandlerChecker和MonitorChecker。代码如下&#xff1a;</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMonitor</span><span class="token punctuation">(</span>Monitor monitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&#34;Monitors can&#39;t be added once the Watchdog is running&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mMonitorChecker<span class="token punctuation">.</span><span class="token function">addMonitor</span><span class="token punctuation">(</span>monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addThread</span><span class="token punctuation">(</span>Handler thread<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&#34;Threads can&#39;t be added once the Watchdog is running&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> String name <span class="token operator">&#61;</span> thread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandlerCheckers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HandlerChecker</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> name<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>比如<code>ActivityManagerService</code>就分别添加了<code>monitor</code>和<code>handler</code>&#xff1b;</p> 
<pre><code>public class ActivityManagerService extends IActivityManager.Stub implements Watchdog.Monitor
{
		// ...
        Watchdog.getInstance().addMonitor(this);
        Watchdog.getInstance().addThread(mHandler);
        
}

</code></pre> 
<h1><a id="watchdog__146"></a>watchdog 机制原理</h1> 
<p>当系统的核心服务都运行之后&#xff0c;SystemServer.java会调用<code>Watchdog.getInstance().start();</code>从而开始执行Watchdog线程的<code>run</code>方法。代码如下&#xff1a;</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">&#64;Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> waitedHalf <span class="token operator">&#61;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>HandlerChecker<span class="token punctuation">&gt;</span></span> blockedCheckers<span class="token punctuation">;</span>
            <span class="token keyword">final</span> String subject<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowRestart<span class="token punctuation">;</span>
            <span class="token keyword">int</span> debuggerWasConnected <span class="token operator">&#61;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> timeout <span class="token operator">&#61;</span> CHECK_INTERVAL<span class="token punctuation">;</span>
                <span class="token comment">// [a] </span>
                <span class="token comment">// Make sure we (re)spin the checkers that have become idle within</span>
                <span class="token comment">// this wait-and-check interval</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">&#61;</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mHandlerCheckers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">&#43;&#43;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    HandlerChecker hc <span class="token operator">&#61;</span> mHandlerCheckers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    hc<span class="token punctuation">.</span><span class="token function">scheduleCheckLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>debuggerWasConnected <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    debuggerWasConnected<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// NOTE: We use uptimeMillis() here because we do not want to increment the time we</span>
                <span class="token comment">// wait while asleep. If the device is asleep then the thing that we are waiting</span>
                <span class="token comment">// to timeout on is asleep as well and won&#39;t have a chance to run, causing a false</span>
                <span class="token comment">// positive on when to kill things.</span>
                <span class="token keyword">long</span> start <span class="token operator">&#61;</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// [b] wait 30s </span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>Debug<span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        debuggerWasConnected <span class="token operator">&#61;</span> <span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait time </span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>Debug<span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        debuggerWasConnected <span class="token operator">&#61;</span> <span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    timeout <span class="token operator">&#61;</span> CHECK_INTERVAL <span class="token operator">-</span> <span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// [c] evaluate checker state</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> waitState <span class="token operator">&#61;</span> <span class="token function">evaluateCheckerCompletionLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>waitState <span class="token operator">&#61;&#61;</span> COMPLETED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// The monitors have returned; reset</span>
                    waitedHalf <span class="token operator">&#61;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>waitState <span class="token operator">&#61;&#61;</span> WAITING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// still waiting but within their configured intervals; back off and recheck</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>waitState <span class="token operator">&#61;&#61;</span> WAITED_HALF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waitedHalf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// We&#39;ve waited half the deadlock-detection interval.  Pull a stack</span>
                        <span class="token comment">// trace and wait another half.</span>
                        ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">&gt;</span></span> pids <span class="token operator">&#61;</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// [d] </span>
                        ActivityManagerService<span class="token punctuation">.</span><span class="token function">dumpStackTraces</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> pids<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                            <span class="token function">getInterestingNativePids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        waitedHalf <span class="token operator">&#61;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">// [e]</span>
                <span class="token comment">// something is overdue!</span>
                blockedCheckers <span class="token operator">&#61;</span> <span class="token function">getBlockedCheckersLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                subject <span class="token operator">&#61;</span> <span class="token function">describeCheckersLocked</span><span class="token punctuation">(</span>blockedCheckers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                allowRestart <span class="token operator">&#61;</span> mAllowRestart<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If we got here, that means that the system is most likely hung.</span>
            <span class="token comment">// First collect stack traces from all threads of the system process.</span>
            <span class="token comment">// Then kill this process so that the system will restart.</span>
            EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>WATCHDOG<span class="token punctuation">,</span> subject<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">&gt;</span></span> pids <span class="token operator">&#61;</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPhonePid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> pids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mPhonePid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Pass !waitedHalf so that just in case we somehow wind up here without having</span>
            <span class="token comment">// dumped the halfway stacks, we properly re-initialize the trace file.</span>
            <span class="token comment">// [f] pint all stack info</span>
            <span class="token keyword">final</span> File stack <span class="token operator">&#61;</span> ActivityManagerService<span class="token punctuation">.</span><span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>
                    <span class="token operator">!</span>waitedHalf<span class="token punctuation">,</span> pids<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token function">getInterestingNativePids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Give some extra time to make sure the stack traces get written.</span>
            <span class="token comment">// The system&#39;s been hanging for a minute, another second or two won&#39;t hurt much.</span>
            SystemClock<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Pull our own kernel thread stacks as well if we&#39;re configured for that</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>RECORD_KERNEL_THREADS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">dumpKernelStackTraces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Trigger the kernel to dump all blocked threads, and backtraces on all CPUs to the kernel log</span>
            <span class="token function">doSysRq</span><span class="token punctuation">(</span><span class="token string">&#39;w&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doSysRq</span><span class="token punctuation">(</span><span class="token string">&#39;l&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Try to add the error to the dropbox, but assuming that the ActivityManager</span>
            <span class="token comment">// itself may be deadlocked.  (which has happened, causing this statement to</span>
            <span class="token comment">// deadlock and the watchdog as a whole to be ineffective)</span>
            Thread dropboxThread <span class="token operator">&#61;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&#34;watchdogWriteToDropbox&#34;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        mActivity<span class="token punctuation">.</span><span class="token function">addErrorToDropBox</span><span class="token punctuation">(</span>
                                <span class="token string">&#34;watchdog&#34;</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token string">&#34;system_server&#34;</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                                subject<span class="token punctuation">,</span> null<span class="token punctuation">,</span> stack<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            dropboxThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                dropboxThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// wait up to 2 seconds for it to return.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

            IActivityController controller<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                controller <span class="token operator">&#61;</span> mController<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// [g] report to controller</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>controller <span class="token operator">!&#61;</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;Reporting stuck state to activity controller&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    Binder<span class="token punctuation">.</span><span class="token function">setDumpDisabled</span><span class="token punctuation">(</span><span class="token string">&#34;Service dumps disabled due to hung system process.&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 1 &#61; keep waiting, -1 &#61; kill system</span>
                    <span class="token keyword">int</span> res <span class="token operator">&#61;</span> controller<span class="token punctuation">.</span><span class="token function">systemNotResponding</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;&#61;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;Activity controller requested to coninue to wait&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        waitedHalf <span class="token operator">&#61;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// [h] kill the process</span>
            <span class="token comment">// Only kill the process if the debugger is not attached.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Debug<span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                debuggerWasConnected <span class="token operator">&#61;</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debuggerWasConnected <span class="token operator">&gt;&#61;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;Debugger connected: Watchdog is *not* killing the system process&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>debuggerWasConnected <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;Debugger was connected: Watchdog is *not* killing the system process&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowRestart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;Restart not allowed: Watchdog is *not* killing the system process&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;*** WATCHDOG KILLING SYSTEM PROCESS: &#34;</span> <span class="token operator">&#43;</span> subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">&#61;</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>blockedCheckers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">&#43;&#43;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> blockedCheckers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#43;</span> <span class="token string">&#34; stack trace:&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    StackTraceElement<span class="token punctuation">[</span><span class="token punctuation">]</span> stackTrace
                            <span class="token operator">&#61;</span> blockedCheckers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>StackTraceElement element<span class="token operator">:</span> stackTrace<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;    at &#34;</span> <span class="token operator">&#43;</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&#34;*** GOODBYE!&#34;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Process<span class="token punctuation">.</span><span class="token function">killProcess</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            waitedHalf <span class="token operator">&#61;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>接下来一步步分析这个函数。我们可以看到&#xff0c;Watchdog线程是一个死循环&#xff0c;也就是说会一直执行。在以上代码片段添加[a]-[g]的标识。分别对应下面的a-g。</p> 
<p>a. 首先遍历系统所有的HandlerChecker&#xff0c;然后调用<code>scheduleCheckLocked</code>执行检查动作。代码片段&#xff1a;</p> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleCheckLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#61;&#61;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token comment">// ...</span>
                mCompleted <span class="token operator">&#61;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCompleted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// we already have a check in flight, so no need</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mCompleted <span class="token operator">&#61;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mCurrentMonitor <span class="token operator">&#61;</span> null<span class="token punctuation">;</span>
            mStartTime <span class="token operator">&#61;</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">postAtFrontOfQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>HanderChecker: 对于名字不是<code>foreground thread</code>的HandlerChecker来说&#xff0c;<code>mMonitors.size()</code>为0&#xff0c;如果<code>mHandler.getLooper().getQueue().isPolling()</code>返回true&#xff0c;说明当前的消息池正常&#xff0c;否则&#xff0c;说明当前的消息已经阻塞。那么后面的<code>mHandler.postAtFrontOfQueue(this)</code>也会阻塞&#xff0c;<code>mCompleted</code>就等于<code>false</code>。</li><li>MoniterChecker: 对于monitorChecker来说&#xff0c;<code>mHandler.postAtFrontOfQueue(this)</code>将会顺利执行&#xff0c;而且消息是在消息队列的最前端。所以会立即执行<code>run</code>方法。代码片段如下&#xff1a;</li></ul> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">&#64;Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">&#61;</span> mMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">&#61;</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size <span class="token punctuation">;</span> i<span class="token operator">&#43;&#43;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Watchdog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mCurrentMonitor <span class="token operator">&#61;</span> mMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mCurrentMonitor<span class="token punctuation">.</span><span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Watchdog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mCompleted <span class="token operator">&#61;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mCurrentMonitor <span class="token operator">&#61;</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>MoniterChecker会执行<code>monitor()</code>方法。我们看<code>ActivityManagerService,java</code>的<code>monitor</code>方法&#xff0c;仅仅是请求了<code>synchronized</code>&#xff0c;如果<code>this</code>被其他地方持有&#xff0c;那么这个地方就会等待。</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>BinderThreadMonitor比较特殊&#xff0c;最终的判断位于<code>frameworks/native/libs/binder/IPCThreadState.cpp</code>&#xff0c;判断方法是当前进行Binder通信的线程数不能超过<code>mMaxThreads</code>&#xff0c;对于SysemServer来说&#xff0c;这个最大值是31&#xff0c;定义在<code>SystemServer.java</code>里面。代码片段&#xff1a;</p> 
<pre><code>void IPCThreadState::blockUntilThreadAvailable()
{
    pthread_mutex_lock(&amp;mProcess-&gt;mThreadCountLock);
    while (mProcess-&gt;mExecutingThreadsCount &gt;&#61; mProcess-&gt;mMaxThreads) {
        ALOGW(&#34;Waiting for thread to be free. mExecutingThreadsCount&#61;%lu mMaxThreads&#61;%lu\n&#34;,
                static_cast&lt;unsigned long&gt;(mProcess-&gt;mExecutingThreadsCount),
                static_cast&lt;unsigned long&gt;(mProcess-&gt;mMaxThreads));
        pthread_cond_wait(&amp;mProcess-&gt;mThreadCountDecrement, &amp;mProcess-&gt;mThreadCountLock);
    }
    pthread_mutex_unlock(&amp;mProcess-&gt;mThreadCountLock);

</code></pre> 
<p>回到<code>HandlerChecker</code>的<code>run</code>方法&#xff0c;如果<code>mCurrentMonitor.monitor();</code>执行完成&#xff0c;没有等待&#xff0c;那么就会赋值<code>mCompleted &#61; true;</code>和<code>mCurrentMonitor &#61; null;</code></p> 
<p>后面的[c]步骤会用到这里的结果。</p> 
<p>b. 由于我们的检查周期是30s&#xff0c;当启动检查之后&#xff0c;会让Watchdog线程等待30s.</p> 
<p>c. 调用<code>evaluateCheckerCompletionLocked</code>计算当前的检查结果。然后调用<code>getCompletionStateLocked</code>获取完成状态。代码片段&#xff1a;</p> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCompletionStateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompleted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> COMPLETED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> latency <span class="token operator">&#61;</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mStartTime<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>latency <span class="token operator">&lt;</span> mWaitMax<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> WAITING<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>latency <span class="token operator">&lt;</span> mWaitMax<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> WAITED_HALF<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> OVERDUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>分别介绍四种状态以及对应的条件&#xff1a;</p> 
<ul><li>COMPLETED&#xff1a; 监控的消息队列没有阻塞且监控的monitor可以正常申请锁。如步骤[a] 所讲,此时<code>mCompleted&#61;true</code>。</li><li>WAITING&#xff1a; 监控的消息队列阻塞时间或者监控的monitor无法申请锁时间在0-30s之间。</li><li>WAITED_HALF&#xff1a;监控的消息队列阻塞时间或者监控的monitor无法申请锁的时间在30-60s之间。</li><li>OVERDUE&#xff1a;监控的消息队列阻塞时间或者监控的monitor无法申请锁的时间超过我们默认的延时60s。</li></ul> 
<p>d. 如果返回的状态是<code>COMPLETED</code>和<code>WAITING</code>&#xff0c;是在可以接受的范围之内&#xff0c;但是如果返回了<code>WAITED_HALF</code>状态&#xff0c;此时会调用<code>ActivityManagerService.dumpStackTraces(true, pids, null, null,getInterestingNativePids())</code>打印当前进程的Trace信息&#xff0c;并且会打印感兴趣的<code>native</code>进程的Trace信息。主要包含如下进程&#xff1a;</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> NATIVE_STACKS_OF_INTEREST <span class="token operator">&#61;</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">&#34;/system/bin/audioserver&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;/system/bin/cameraserver&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;/system/bin/drmserver&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;/system/bin/mediadrmserver&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;/system/bin/mediaserver&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;/system/bin/sdcard&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;/system/bin/surfaceflinger&#34;</span><span class="token punctuation">,</span>
        <span class="token string">&#34;media.extractor&#34;</span><span class="token punctuation">,</span> <span class="token comment">// system/bin/mediaextractor</span>
        <span class="token string">&#34;media.codec&#34;</span><span class="token punctuation">,</span> <span class="token comment">// vendor/bin/hw/android.hardware.media.omx&#64;1.0-service</span>
        <span class="token string">&#34;com.android.bluetooth&#34;</span><span class="token punctuation">,</span>  <span class="token comment">// Bluetooth service</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>e. 如果返回了<code>OVERDUE</code>状态&#xff0c;说明已经超时&#xff0c;会通过<code>getBlockedCheckersLocked</code>获取当前延时的checker类型&#xff0c;并且通过<code>describeCheckersLocked</code>打印当前阻塞信息。</p> 
<ul><li>MonitorChecker 延时&#xff1a;打印<code>Blocked in monitor &#43; monitor名字 &#43; on &#43; 线程名</code>。</li><li>HandlerChecker 延时&#xff1a;打印<code>Blocked in handler on &#43; 名字&#xff08;比如ui thread&#xff09; &#43; 线程名</code></li></ul> 
<p>f. 再次调用<code>ActivityManagerService.dumpStackTraces</code>打印当前的进程和感兴趣的native进程调用Stack。调用<code>dumpKernelStackTraces</code>打印kernel的回调。还会执行doSysRq来打印当前kernel和cpu的状态。</p> 
<ul><li>doSysRq(‘w’): Dumps tasks that are in uninterruptable (blocked) state.</li><li>doSysRq(‘l’): Shows a stack backtrace for all active CPUs.</li></ul> 
<p>而且会把当前的Error写进DropBox里面。</p> 
<p>g. 如果设置了<code>ActivityController</code>&#xff0c;会将当前的信息传递过去。</p> 
<p>h.WatchDog系统自杀&#xff0c;向LOG里面输出<code>WATCHDOG KILLING SYSTEM PROCESS</code>的信息&#xff0c;调用<code>Process.killProcess(Process.myPid());</code>将system杀掉。</p> 
<h1><a id="_441"></a>总结</h1> 
<p>1、Watchdog用HandlerChecker来监控消息队列是否发生阻塞&#xff0c;用MonitorChecker来监控系统核心服务是否发生长时间持锁。<br /> 2、HandlerChecker通过&#96;&#96;mHandler.getLooper().getQueue().isPolling()<code>判断是否超时&#xff0c;BinderThreadMonitor主要是通过判断Binder线程是否超过了系统最大值来判断是否超时&#xff0c;其他MonitorChecker通过</code>synchronized(this)&#96;判断是否超时。<br /> 3、超时之后&#xff0c;系统会打印一系列的信息&#xff0c;包括当前进程以及核心native进程的Stacktrace&#xff0c;kernel线程Stacktrace&#xff0c;打印Kernel里面blocked的线程以及所有CPU的backtraces。<br /> 4. 超时之后&#xff0c;Watchdog会杀掉自己&#xff0c;导致zygote重启。</p>
                </div>
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-d7a94ec6ab.css" rel="stylesheet">
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-49037e4d27.css" rel="stylesheet">
        </div>
    </article>