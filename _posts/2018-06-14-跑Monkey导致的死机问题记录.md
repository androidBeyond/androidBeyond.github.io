---
layout:     post
title:      跑Monkey导致的死机问题记录
subtitle:   跑Monkey会遇到各种奇怪的问题，记录下这个死锁问题的分析过程
date:       2018-06-14
author:     coderman
header-img: img/article-bg.jpg
top: false
catalog: true
tags:
    - 稳定性
    - 框架问题
    - 疑难问题
---

<h2 id="一问题现象">一、问题现象</h2> 
<p>1、界面定住&#xff0c;没有任何刷新&#xff0c;所有输入事件无效&#xff0c;包括power key</p> 
<p>2、adb shell可以连接并操作手机</p> 
<p>3、手机的data和sdcard存储空间已满</p> 
<p>4、watchdog没有重启system server</p> 
<h2 id="二解决方案">二、解决方案</h2> 
<p>通过初步分析、深入分析&#xff08;具体分析过程和关键代码及log在下面&#xff09;我们知道了问题的原因&#xff1a;</p> 
<p>1、monkey测试的过程中起了bugreport&#xff0c;并将bugreport输出到stdout的log通过同步pipe循环读取出来然后write到sdcard的文件中&#xff0c;但是由于sdcard空间满了&#xff0c;write的时候发生了IO error导致monkey异常跳出了读取同步pipe的流程&#xff0c;由于bugreport还没有将log输出完毕所以会一直等待&#xff0c;而monkey则继续运行。</p> 
<p>2、bugreport起来之后通过set property的方式触发了dumpstate去获取log&#xff0c;然后通过同步local socket&#xff08;以下为了描述方便简短起见简称socket&#xff09;与dumpstate建立连接&#xff0c;将dumpstate通过socket输出的log读取出来写到stdout。</p> 
<p>3、dumpstate起来之后会首先将与bugreport的socket通过dup2重定向到stdout&#xff0c;然后执行一系列的抓取log信息的动作&#xff0c;包括cat proc节点、执行dumpsys batterystats等&#xff0c;这些动作都是通过run command的方式起的即fork一个进程&#xff0c;然后执行execvp&#xff0c;fork会继承dumpstate的文件描述符&#xff0c;所以起dumpsys batterystats之后dumpsys中的stdout就是与bugreport通信的socket&#xff0c;dumpsys batterystats会将stdout 文件描述符通过binder传递到system server中。</p> 
<p>4、binder driver负责在system server进程中重新分配一个文件描述符来指向与bugreport通信的socket&#xff0c;system server收到dump batterystats的请求后开始把信息输出到bugreport的socket&#xff0c;由于bugreport被write block&#xff0c;导致system server输出的log无法被读取&#xff0c;从而引起system server的dump thread拿着batterystats的一个lock而block了进程内多个其他thread。</p> 
<p>5、monkey继续运行向system server发起了dumpsys meminfo的请求&#xff0c;由于dump batterystats的线程拿着一个关键的lock没有释放&#xff0c;导致dumpsys meminfo一直无法得到执行而block了monkey主线程。</p> 
<p>6、watchdog线程检测到system server被block之后开始执行相关逻辑&#xff0c;其中就有调用IActivityController的systemNotResponding方法&#xff0c;这个IActivityController是monkey注册的&#xff0c;所有就会跨进程调用到了monkey端&#xff0c;monkey的binder thread收到这个请求之后开始执行&#xff0c;但是执行的过程中需要monkey主线dump完需要的信息后notify它&#xff0c;由于monkey主线程dumpsys meminfo的过程中block&#xff0c;所以导致watchdog线程也被block而无法kill system server。 <br />
 <img src="https://img-blog.csdnimg.cn/60eb930ef5c546fab5fdffd7e3475236.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="各个进程之间的关系" title="" /></p> 
<p>针对问题的原因&#xff0c;给出以下解决方案&#xff1a; <br /> 解开死锁问题的根本死结&#xff0c;当monkey向sdcard写log的时候&#xff0c;如果发生IO error&#xff0c;我们捕获它并继续将monkey起的bugreport的输出读完&#xff0c;从而使system server的dump线程释放持有的lock&#xff0c;使其他线程继续正常工作&#xff0c;dumpsys、dumpstate、cat、bugreport等都能完成自己的同步输入输出&#xff0c;monkey主线程也会恢复&#xff0c;整个系统恢复正常。</p> 
<h2 id="三初步分析">三、初步分析</h2> 
<p>1、查看system server的traces发现多线程互锁&#xff0c;主线程需要的锁在thread 33手里</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;main&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">1</span> Blocked
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x74869fb8</span> self&#61;<span class="hljs-number">0x5588e4e100</span>
  | sysTid&#61;<span class="hljs-number">3230</span> nice&#61;-<span class="hljs-number">2</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7fa92efe80</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">153835271056</span> <span class="hljs-number">66149983041</span> <span class="hljs-number">217214</span> ) utm&#61;<span class="hljs-number">9061</span> stm&#61;<span class="hljs-number">6322</span> core&#61;<span class="hljs-number">4</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7ff873d000</span>-<span class="hljs-number">0x7ff873f000</span> stackSize&#61;<span class="hljs-number">8</span>MB
  | held mutexes&#61;
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.AlarmManagerService</span>$ResultReceiver<span class="hljs-preprocessor">.onSendFinished</span>(AlarmManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">2266</span>)
  - waiting to lock &lt;<span class="hljs-number">0x2310f49f</span>&gt; (a java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.Object</span>) held by thread <span class="hljs-number">33</span>
  at android<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.PendingIntent</span>$FinishedDispatcher<span class="hljs-preprocessor">.run</span>(PendingIntent<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">219</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Handler</span><span class="hljs-preprocessor">.handleCallback</span>(Handler<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">739</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Handler</span><span class="hljs-preprocessor">.dispatchMessage</span>(Handler<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">95</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Looper</span><span class="hljs-preprocessor">.loop</span>(Looper<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">135</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.SystemServer</span><span class="hljs-preprocessor">.run</span>(SystemServer<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">296</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.SystemServer</span><span class="hljs-preprocessor">.main</span>(SystemServer<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">188</span>)
  at java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.reflect</span><span class="hljs-preprocessor">.Method</span><span class="hljs-preprocessor">.invoke</span>!(Native method)
  at java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.reflect</span><span class="hljs-preprocessor">.Method</span><span class="hljs-preprocessor">.invoke</span>(Method<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">372</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.ZygoteInit</span>$MethodAndArgsCaller<span class="hljs-preprocessor">.run</span>(ZygoteInit<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">908</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.ZygoteInit</span><span class="hljs-preprocessor">.main</span>(ZygoteInit<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">703</span>)</code></pre> 
<p>2、thread 33需要的锁在thread 86手里</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;AlarmManager&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">33</span> Blocked
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x132f14c0</span> self&#61;<span class="hljs-number">0x7f92814780</span>
  | sysTid&#61;<span class="hljs-number">3773</span> nice&#61;<span class="hljs-number">0</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f93cb7d50</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">7677732166</span> <span class="hljs-number">3315508747</span> <span class="hljs-number">11830</span> ) utm&#61;<span class="hljs-number">569</span> stm&#61;<span class="hljs-number">198</span> core&#61;<span class="hljs-number">5</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f9233f000</span>-<span class="hljs-number">0x7f92341000</span> stackSize&#61;<span class="hljs-number">1036</span>KB
  | held mutexes&#61;
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span><span class="hljs-preprocessor">.acquireWakeLockInternal</span>(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">753</span>)
  - waiting to lock &lt;<span class="hljs-number">0x012c60c0</span>&gt; (a java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.Object</span>) held by thread <span class="hljs-number">86</span>
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span><span class="hljs-preprocessor">.access</span>$3300(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">87</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span>$BinderService<span class="hljs-preprocessor">.acquireWakeLock</span>(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">2990</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.PowerManager</span>$WakeLock<span class="hljs-preprocessor">.acquireLocked</span>(PowerManager<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">986</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.PowerManager</span>$WakeLock<span class="hljs-preprocessor">.acquire</span>(PowerManager<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">954</span>)
  - locked &lt;&#64;addr&#61;<span class="hljs-number">0x1300b8a0</span>&gt; (a android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.AlarmManagerService</span><span class="hljs-preprocessor">.deliverAlarmsLocked</span>(AlarmManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">1820</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.AlarmManagerService</span>$AlarmThread<span class="hljs-preprocessor">.run</span>(AlarmManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">1981</span>)
  - locked &lt;<span class="hljs-number">0x2310f49f</span>&gt; (a java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.Object</span>)</code></pre> 
<p>3、thread 86需要的锁在thread 84手里</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;Binder_E&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">86</span> Blocked
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x141230a0</span> self&#61;<span class="hljs-number">0x7f8b096630</span>
  | sysTid&#61;<span class="hljs-number">5467</span> nice&#61;<span class="hljs-number">0</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f8b0960e0</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">169694491361</span> <span class="hljs-number">86744323304</span> <span class="hljs-number">358303</span> ) utm&#61;<span class="hljs-number">11590</span> stm&#61;<span class="hljs-number">5379</span> core&#61;<span class="hljs-number">5</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f8ada5000</span>-<span class="hljs-number">0x7f8ada7000</span> stackSize&#61;<span class="hljs-number">1012</span>KB
  | held mutexes&#61;
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.am</span><span class="hljs-preprocessor">.BatteryStatsService</span><span class="hljs-preprocessor">.noteStartWakelock</span>(BatteryStatsService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">253</span>)
  - waiting to lock &lt;<span class="hljs-number">0x052efb00</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStatsImpl</span>) held by thread <span class="hljs-number">84</span>
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.Notifier</span><span class="hljs-preprocessor">.onWakeLockAcquired</span>(Notifier<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">158</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span><span class="hljs-preprocessor">.notifyWakeLockAcquiredLocked</span>(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">963</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span><span class="hljs-preprocessor">.acquireWakeLockInternal</span>(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">805</span>)
  - locked &lt;<span class="hljs-number">0x012c60c0</span>&gt; (a java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.Object</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span><span class="hljs-preprocessor">.access</span>$3300(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">87</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.power</span><span class="hljs-preprocessor">.PowerManagerService</span>$BinderService<span class="hljs-preprocessor">.acquireWakeLock</span>(PowerManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">2990</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.IPowerManager</span>$Stub<span class="hljs-preprocessor">.onTransact</span>(IPowerManager<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">66</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.execTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">446</span>)</code></pre> 
<p>4、thread 84拿着锁在做IO操作&#xff0c;但是这个IO操作为什么会一直block&#xff1f;</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;Binder_C&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">84</span> Native
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x1411e0a0</span> self&#61;<span class="hljs-number">0x7f8b093e10</span>
  | sysTid&#61;<span class="hljs-number">5394</span> nice&#61;-<span class="hljs-number">20</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f8b091de0</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">164975127905</span> <span class="hljs-number">86670873575</span> <span class="hljs-number">354263</span> ) utm&#61;<span class="hljs-number">11207</span> stm&#61;<span class="hljs-number">5290</span> core&#61;<span class="hljs-number">4</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f8aaa1000</span>-<span class="hljs-number">0x7f8aaa3000</span> stackSize&#61;<span class="hljs-number">1012</span>KB
  | held mutexes&#61;
  kernel: __switch_to&#43;<span class="hljs-number">0x70</span>/<span class="hljs-number">0x7c</span>
  kernel: sock_alloc_send_pskb&#43;<span class="hljs-number">0x25c</span>/<span class="hljs-number">0x314</span>
  kernel: sock_alloc_send_skb&#43;<span class="hljs-number">0x18</span>/<span class="hljs-number">0x24</span>
  kernel: unix_stream_sendmsg&#43;<span class="hljs-number">0x15c</span>/<span class="hljs-number">0x340</span>
  kernel: sock_aio_write&#43;<span class="hljs-number">0x124</span>/<span class="hljs-number">0x140</span>
  kernel: do_sync_write&#43;<span class="hljs-number">0x74</span>/<span class="hljs-number">0xa0</span>
  kernel: vfs_write&#43;<span class="hljs-number">0xd4</span>/<span class="hljs-number">0x178</span>
  kernel: SyS_write&#43;<span class="hljs-number">0x44</span>/<span class="hljs-number">0x74</span>
  kernel: cpu_switch_to&#43;<span class="hljs-number">0x48</span>/<span class="hljs-number">0x4c</span>
  native: <span class="hljs-preprocessor">#00 pc 0005fca4  /system/lib64/libc.so (write&#43;4)</span>
  native: <span class="hljs-preprocessor">#01 pc 0000136c  /system/vendor/lib64/libNimsWrap.so (write&#43;44)</span>
  native: <span class="hljs-preprocessor">#02 pc 000368d4  /system/lib64/libjavacore.so (???)</span>
  native: <span class="hljs-preprocessor">#03 pc 003c0300  /data/dalvik-cache/arm64/system&#64;framework&#64;boot.oat (Java_libcore_io_Posix_writeBytes__Ljava_io_FileDescriptor_2Ljava_lang_Object_2II&#43;212)</span>
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.Posix</span><span class="hljs-preprocessor">.writeBytes</span>(Native method)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.Posix</span><span class="hljs-preprocessor">.write</span>(Posix<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">258</span>)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.BlockGuardOs</span><span class="hljs-preprocessor">.write</span>(BlockGuardOs<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">313</span>)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.IoBridge</span><span class="hljs-preprocessor">.write</span>(IoBridge<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">497</span>)
  at java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.FileOutputStream</span><span class="hljs-preprocessor">.write</span>(FileOutputStream<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">186</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.flushBytesLocked</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">334</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.flushLocked</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">355</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.appendLocked</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">303</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.print</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">466</span>)
  - locked &lt;&#64;addr&#61;<span class="hljs-number">0x13c93200</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span>$DummyWriter)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStats</span>$HistoryPrinter<span class="hljs-preprocessor">.printNextItem</span>(BatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">3503</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStats</span><span class="hljs-preprocessor">.dumpHistoryLocked</span>(BatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">3915</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStats</span><span class="hljs-preprocessor">.dumpLocked</span>(BatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">3962</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStatsImpl</span><span class="hljs-preprocessor">.dumpLocked</span>(BatteryStatsImpl<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">8843</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.am</span><span class="hljs-preprocessor">.BatteryStatsService</span><span class="hljs-preprocessor">.dump</span>(BatteryStatsService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">947</span>)
  - locked &lt;<span class="hljs-number">0x052efb00</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStatsImpl</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.dump</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">319</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.onTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">285</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.IBatteryStats</span>$Stub<span class="hljs-preprocessor">.onTransact</span>(IBatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">832</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.execTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">446</span>)</code></pre> 
<p>带着问题与相关的同事沟通&#xff0c;给出的结论是同步IO操作&#xff0c;如果读端没有将写端写入到buffer或者写端自带buffer中的数据读取完&#xff0c;一旦写端将buffer写满仍然需要继续写或者写端自带buffer没人读&#xff0c;写端就会block&#xff0c;以此推论自己模拟出了类似的写端调用栈&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs http"><span class="hljs-attribute">kernel</span>: <span class="hljs-string">__switch_to&#43;0x70/0x7c</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">sock_alloc_send_pskb&#43;0x25c/0x314</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">sock_alloc_send_skb&#43;0x18/0x24</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">unix_stream_sendmsg&#43;0x15c/0x340</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">sock_aio_write&#43;0x124/0x140</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">do_sync_write&#43;0x74/0xa0</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">vfs_write&#43;0xd4/0x178</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">SyS_write&#43;0x44/0x74</span>
<span class="hljs-attribute">kernel</span>: <span class="hljs-string">cpu_switch_to&#43;0x48/0x4c</span></code></pre> 
<p>读端的调用栈&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs xml">[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] __switch_to&#43;0x70/0x7c
[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] __skb_recv_datagram&#43;0x408/0x49c
[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] skb_recv_datagram&#43;0x38/0x5c
[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] unix_accept&#43;0x6c/0x154
[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] SyS_accept4&#43;0x104/0x1e0
[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] el0_svc_naked&#43;0x20/0x28
[<span class="hljs-tag">&lt;<span class="hljs-title">0000000000000000</span>&gt;</span>] 0xffffffffffffffff</code></pre> 
<p>与此同时也带来了两个好问题&#xff1a;</p> 
<p>1.读端的线程是哪个&#xff1f;这时候在干什么&#xff1f;没有找到对应的bugreport.</p> 
<p>2.watchdog为什么没有杀掉system_server呢&#xff1f;</p> 
<p>当然还少不了建议的解决方案&#xff1a;</p> 
<p>1.采用异步写.</p> 
<p>2.读端要及时关闭socket.</p> 
<p>问题就这样结束了吗&#xff1f;当然不能&#xff01;</p> 
<h2 id="四深入分析">四、深入分析</h2> 
<p>首先解释第二个问题&#xff0c;watchdog为什么没有杀掉system_server呢&#xff1f;</p> 
<p>watchdog thread在调用android.app.IActivityController<span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1-Frame">
  
   <span class="math" id="MathJax-Span-1" style="width: 2.484em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.803em; height: 0px; font-size: 137%;"><span style="position: absolute; clip: rect(1.706em 1000em 2.679em -0.436em); top: -2.528em; left: 0.002em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: STIXGeneral-Italic;">S<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mi" id="MathJax-Span-4" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mi" id="MathJax-Span-5" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-6" style="font-family: STIXGeneral-Italic;">b</span></span><span style="display: inline-block; width: 0px; height: 2.533em;"></span></span></span><span style="border-left: 0.003em solid; display: inline-block; overflow: hidden; width: 0px; height: 1.07em; vertical-align: -0.063em;"></span></span>
  </span><script type="math/tex" id="MathJax-Element-1">Stub</script>Proxy.systemNotResponding时被block&#xff0c;导致不能及时顺序的执行kill system server的动作&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;watchdog&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">71</span> Native
group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x12edbe00</span> self&#61;<span class="hljs-number">0x7f90d1bdc0</span>
sysTid&#61;<span class="hljs-number">5070</span> nice&#61;<span class="hljs-number">0</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f90d1c6b0</span>
state&#61;S schedstat&#61;( <span class="hljs-number">876766452</span> <span class="hljs-number">162402010</span> <span class="hljs-number">4730</span> ) utm&#61;<span class="hljs-number">17</span> stm&#61;<span class="hljs-number">70</span> core&#61;<span class="hljs-number">1</span> HZ&#61;<span class="hljs-number">100</span>
stack&#61;<span class="hljs-number">0x7f8c410000</span>-<span class="hljs-number">0x7f8c412000</span> stackSize&#61;<span class="hljs-number">1036</span>KB
held mutexes&#61;
<span class="hljs-label">kernel:</span> __switch_to&#43;<span class="hljs-number">0x70</span>/<span class="hljs-number">0x7c</span>
<span class="hljs-label">kernel:</span> binder_thread_read&#43;<span class="hljs-number">0x464</span>/<span class="hljs-number">0xe8c</span>
<span class="hljs-label">kernel:</span> binder_ioctl&#43;<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x824</span>
<span class="hljs-label">kernel:</span> do_vfs_ioctl&#43;<span class="hljs-number">0x4a4</span>/<span class="hljs-number">0x578</span>
<span class="hljs-label">kernel:</span> SyS_ioctl&#43;<span class="hljs-number">0x5c</span>/<span class="hljs-number">0x88</span>
<span class="hljs-label">kernel:</span> cpu_switch_to&#43;<span class="hljs-number">0x48</span>/<span class="hljs-number">0x4c</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#00 pc 0005ec3c /system/lib64/libc.so (__ioctl&#43;4)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#01 pc 00068eb0 /system/lib64/libc.so (ioctl&#43;100)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#02 pc 000275f0 /system/lib64/libbinder.so (android::IPCThreadState::talkWithDriver(bool)&#43;164)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#03 pc 00028050 /system/lib64/libbinder.so (android::IPCThreadState::waitForResponse(android::Parcel*, int*)&#43;112)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#04 pc 000282c4 /system/lib64/libbinder.so (android::IPCThreadState::transact(int, unsigned int, android::Parcel const&amp;, android::Parcel*, unsigned int)&#43;176)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#05 pc 0001ff38 /system/lib64/libbinder.so (android::BpBinder::transact(unsigned int, android::Parcel const&amp;, android::Parcel*, unsigned int)&#43;64)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#06 pc 000dcd58 /system/lib64/libandroid_runtime.so (???)</span>
<span class="hljs-label">native:</span> <span class="hljs-preprocessor">#07 pc 005fcfb0 /data/dalvik-cache/arm64/system&#64;framework&#64;boot.oat (Java_android_os_BinderProxy_transactNative__ILandroid_os_Parcel_2Landroid_os_Parcel_2I&#43;212)</span>
at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BinderProxy</span><span class="hljs-preprocessor">.transactNative</span>(Native method)
at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BinderProxy</span><span class="hljs-preprocessor">.transact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">496</span>)
at android<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.IActivityController</span>$Stub$Proxy<span class="hljs-preprocessor">.systemNotResponding</span>(IActivityController<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">293</span>)
at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.Watchdog</span><span class="hljs-preprocessor">.run</span>(Watchdog<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">487</span>)</code></pre> 
<p><img src="https://img-blog.csdnimg.cn/8f781947443e4675b940035a369e5ae2.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="watchdog代码逻辑" title="" /></p> 
<p>执行android.app.IActivityController<span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-8-Frame">
  
   <span class="math" id="MathJax-Span-43" style="width: 2.484em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.803em; height: 0px; font-size: 137%;"><span style="position: absolute; clip: rect(1.706em 1000em 2.679em -0.436em); top: -2.528em; left: 0.002em;"><span class="mrow" id="MathJax-Span-44"><span class="mi" id="MathJax-Span-45" style="font-family: STIXGeneral-Italic;">S<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mi" id="MathJax-Span-46" style="font-family: STIXGeneral-Italic;">t<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mi" id="MathJax-Span-47" style="font-family: STIXGeneral-Italic;">u</span><span class="mi" id="MathJax-Span-48" style="font-family: STIXGeneral-Italic;">b</span></span><span style="display: inline-block; width: 0px; height: 2.533em;"></span></span></span><span style="border-left: 0.003em solid; display: inline-block; overflow: hidden; width: 0px; height: 1.07em; vertical-align: -0.063em;"></span></span>
  </span><script type="math/tex" id="MathJax-Element-8">Stub</script>Proxy.systemNotResponding调用到了何方神圣&#xff1f;为什么会被block&#xff1f;</p> 
<p>通过搜索代码和trace定位到是调用到了monkey中&#xff0c;而且发现了条件循环和wait&#xff1a; <br /> 
<img src="https://img-blog.csdnimg.cn/a9c45ab849a4432caa701b2845dbf49e.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="systemNotResponding" title="" /></p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;Binder_1&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">15</span> Waiting
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x12cbb0a0</span> self&#61;<span class="hljs-number">0x55cc7ec1e0</span>
  | sysTid&#61;<span class="hljs-number">12015</span> nice&#61;<span class="hljs-number">0</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x55cc801c50</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">959522781</span> <span class="hljs-number">386691057</span> <span class="hljs-number">2262</span> ) utm&#61;<span class="hljs-number">41</span> stm&#61;<span class="hljs-number">54</span> core&#61;<span class="hljs-number">5</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f82c72000</span>-<span class="hljs-number">0x7f82c74000</span> stackSize&#61;<span class="hljs-number">1012</span>KB
  | held mutexes&#61;
  at java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.Object</span><span class="hljs-preprocessor">.wait</span>!(Native method)
  - waiting on &lt;<span class="hljs-number">0x121ce47e</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span>$ActivityController<span class="hljs-preprocessor">.systemNotResponding</span>(Monkey<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">432</span>)
  - locked &lt;<span class="hljs-number">0x121ce47e</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span>)
  at android<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.IActivityController</span>$Stub<span class="hljs-preprocessor">.onTransact</span>(IActivityController<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">130</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.execTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">446</span>)</code></pre> 
<p>mWatchdogWaiting置为false的条件是跑完runMonkeyCycles之后走到下面才设置false并notifyall&#xff0c;但是当前monkey的main thread也block了&#xff1a; <br />
 <img src="https://img-blog.csdnimg.cn/bc2994fc60c44c39b9b7f40ad2d4fc86.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_18,color_FFFFFF,t_70,g_se,x_16" alt="mWatchdogWaiting条件和notify" title="" /></p> 
<p>monkey的main thread执行reportDumpsysMemInfo时被block的trace&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;main&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">1</span> Native
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x12c410a0</span> self&#61;<span class="hljs-number">0x55cc7c7510</span>
  | sysTid&#61;<span class="hljs-number">12001</span> nice&#61;<span class="hljs-number">0</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f8cf59e80</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">216727507148</span> <span class="hljs-number">81167424419</span> <span class="hljs-number">501554</span> ) utm&#61;<span class="hljs-number">17390</span> stm&#61;<span class="hljs-number">4282</span> core&#61;<span class="hljs-number">4</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7fcefa3000</span>-<span class="hljs-number">0x7fcefa5000</span> stackSize&#61;<span class="hljs-number">8</span>MB
  | held mutexes&#61;
  kernel: __switch_to&#43;<span class="hljs-number">0x70</span>/<span class="hljs-number">0x7c</span>
  kernel: pipe_wait&#43;<span class="hljs-number">0x60</span>/<span class="hljs-number">0x88</span>
  kernel: pipe_read&#43;<span class="hljs-number">0x34c</span>/<span class="hljs-number">0x3cc</span>
  kernel: do_sync_read&#43;<span class="hljs-number">0x74</span>/<span class="hljs-number">0xa0</span>
  kernel: vfs_read&#43;<span class="hljs-number">0xa0</span>/<span class="hljs-number">0x12c</span>
  kernel: SyS_read&#43;<span class="hljs-number">0x44</span>/<span class="hljs-number">0x74</span>
  kernel: cpu_switch_to&#43;<span class="hljs-number">0x48</span>/<span class="hljs-number">0x4c</span>
  native: <span class="hljs-preprocessor">#00 pc 0005f68c  /system/lib64/libc.so (read&#43;4)</span>
  native: <span class="hljs-preprocessor">#01 pc 0003947c  /system/lib64/libjavacore.so (???)</span>
  native: <span class="hljs-preprocessor">#02 pc 003c0300  /data/dalvik-cache/arm64/system&#64;framework&#64;boot.oat (Java_libcore_io_Posix_readBytes__Ljava_io_FileDescriptor_2Ljava_lang_Object_2II&#43;212)</span>
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.Posix</span><span class="hljs-preprocessor">.readBytes</span>(Native method)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.Posix</span><span class="hljs-preprocessor">.read</span>(Posix<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">165</span>)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.BlockGuardOs</span><span class="hljs-preprocessor">.read</span>(BlockGuardOs<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">230</span>)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.IoBridge</span><span class="hljs-preprocessor">.read</span>(IoBridge<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">472</span>)
  at java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.FileInputStream</span><span class="hljs-preprocessor">.read</span>(FileInputStream<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">177</span>)
  at java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.InputStreamReader</span><span class="hljs-preprocessor">.read</span>(InputStreamReader<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">231</span>)
  - locked &lt;&#64;addr&#61;<span class="hljs-number">0x12cc22a0</span>&gt; (a java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.ProcessManager</span>$ProcessInputStream)
  at java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.BufferedReader</span><span class="hljs-preprocessor">.fillBuf</span>(BufferedReader<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">145</span>)
  at java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.BufferedReader</span><span class="hljs-preprocessor">.readLine</span>(BufferedReader<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">397</span>)
  - locked &lt;&#64;addr&#61;<span class="hljs-number">0x12cc2460</span>&gt; (a java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.InputStreamReader</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span><span class="hljs-preprocessor">.commandLineReport</span>(Monkey<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">502</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span><span class="hljs-preprocessor">.reportDumpsysMemInfo</span>(Monkey<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">469</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span><span class="hljs-preprocessor">.runMonkeyCycles</span>(Monkey<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">1192</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span><span class="hljs-preprocessor">.run</span>(Monkey<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">700</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.commands</span><span class="hljs-preprocessor">.monkey</span><span class="hljs-preprocessor">.Monkey</span><span class="hljs-preprocessor">.main</span>(Monkey<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">553</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.RuntimeInit</span><span class="hljs-preprocessor">.nativeFinishInit</span>(Native method)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.RuntimeInit</span><span class="hljs-preprocessor">.main</span>(RuntimeInit<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">251</span>)</code></pre> 
<p>又看到了同步IO被block的调用栈&#xff0c;这次是读端block。那么问题就来了&#xff0c;读端是谁&#xff1f;为什么写端没有写&#xff1f;</p> 
<p>接下来watchdog没有kill system server的问题就转变为monkey的主线程为什么会被block&#xff1f;导致不能及时的设置条件为false并notifyall从而使watchdog继续工作&#xff1f;</p> 
<p>好了&#xff0c;再捋一捋&#xff0c;有点乱&#xff1a;</p> 
<p>watchdog thread等待monkey的binder thread执行完systemNotResponding&#xff0c;monkey的binder thread又等着monkey的main thread执行完reportDumpsysMemInfo去notify自己&#xff0c;而reportDumpsysMemInfo的执行需要拿到一个BatteryStatsImpl实例的锁&#xff0c;但是BatteryStatsImpl实例的锁又被tid&#61;84的binder thread拿着&#xff0c;也就是上面最早执行同步socket操作的thread&#xff0c;绕了一大圈发现这是一个连环死锁&#xff0c;最终死锁的关键还是这个tid&#61;84的thread.</p> 
<p>system server中dumpsys meminfo被block的trace&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;Binder_1&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">16</span> Blocked
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x12ceb0a0</span> self&#61;<span class="hljs-number">0x5589025e20</span>
  | sysTid&#61;<span class="hljs-number">3256</span> nice&#61;<span class="hljs-number">0</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x5588f5c810</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">187370245727</span> <span class="hljs-number">86634518556</span> <span class="hljs-number">362219</span> ) utm&#61;<span class="hljs-number">12721</span> stm&#61;<span class="hljs-number">6016</span> core&#61;<span class="hljs-number">6</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f93e8c000</span>-<span class="hljs-number">0x7f93e8e000</span> stackSize&#61;<span class="hljs-number">1012</span>KB
  | held mutexes&#61;
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.am</span><span class="hljs-preprocessor">.ActivityManagerService</span><span class="hljs-preprocessor">.updateCpuStatsNow</span>(ActivityManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">2304</span>)
  - waiting to lock &lt;<span class="hljs-number">0x052efb00</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStatsImpl</span>) held by thread <span class="hljs-number">84</span>
  - locked &lt;<span class="hljs-number">0x1a8a1243</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.ProcessCpuTracker</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.am</span><span class="hljs-preprocessor">.ActivityManagerService</span><span class="hljs-preprocessor">.dumpApplicationMemoryUsage</span>(ActivityManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">14708</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.am</span><span class="hljs-preprocessor">.ActivityManagerService</span>$MemBinder<span class="hljs-preprocessor">.dump</span>(ActivityManagerService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">2002</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.dump</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">319</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.onTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">285</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.execTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">446</span>)</code></pre> 
<p>好你个thread 84&#xff0c;竟然这么多人被你block&#xff0c;你到底在干啥&#xff1f;我们再看看它的trace&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-string">&#34;Binder_C&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">84</span> Native
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> sCount&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x1411e0a0</span> self&#61;<span class="hljs-number">0x7f8b093e10</span>
  | sysTid&#61;<span class="hljs-number">5394</span> nice&#61;-<span class="hljs-number">20</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f8b091de0</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">164975127905</span> <span class="hljs-number">86670873575</span> <span class="hljs-number">354263</span> ) utm&#61;<span class="hljs-number">11207</span> stm&#61;<span class="hljs-number">5290</span> core&#61;<span class="hljs-number">4</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f8aaa1000</span>-<span class="hljs-number">0x7f8aaa3000</span> stackSize&#61;<span class="hljs-number">1012</span>KB
  | held mutexes&#61;
  kernel: __switch_to&#43;<span class="hljs-number">0x70</span>/<span class="hljs-number">0x7c</span>
  kernel: sock_alloc_send_pskb&#43;<span class="hljs-number">0x25c</span>/<span class="hljs-number">0x314</span>
  kernel: sock_alloc_send_skb&#43;<span class="hljs-number">0x18</span>/<span class="hljs-number">0x24</span>
  kernel: unix_stream_sendmsg&#43;<span class="hljs-number">0x15c</span>/<span class="hljs-number">0x340</span>
  kernel: sock_aio_write&#43;<span class="hljs-number">0x124</span>/<span class="hljs-number">0x140</span>
  kernel: do_sync_write&#43;<span class="hljs-number">0x74</span>/<span class="hljs-number">0xa0</span>
  kernel: vfs_write&#43;<span class="hljs-number">0xd4</span>/<span class="hljs-number">0x178</span>
  kernel: SyS_write&#43;<span class="hljs-number">0x44</span>/<span class="hljs-number">0x74</span>
  kernel: cpu_switch_to&#43;<span class="hljs-number">0x48</span>/<span class="hljs-number">0x4c</span>
  native: <span class="hljs-preprocessor">#00 pc 0005fca4  /system/lib64/libc.so (write&#43;4)</span>
  native: <span class="hljs-preprocessor">#01 pc 0000136c  /system/vendor/lib64/libNimsWrap.so (write&#43;44)</span>
  native: <span class="hljs-preprocessor">#02 pc 000368d4  /system/lib64/libjavacore.so (???)</span>
  native: <span class="hljs-preprocessor">#03 pc 003c0300  /data/dalvik-cache/arm64/system&#64;framework&#64;boot.oat (Java_libcore_io_Posix_writeBytes__Ljava_io_FileDescriptor_2Ljava_lang_Object_2II&#43;212)</span>
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.Posix</span><span class="hljs-preprocessor">.writeBytes</span>(Native method)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.Posix</span><span class="hljs-preprocessor">.write</span>(Posix<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">258</span>)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.BlockGuardOs</span><span class="hljs-preprocessor">.write</span>(BlockGuardOs<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">313</span>)
  at libcore<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.IoBridge</span><span class="hljs-preprocessor">.write</span>(IoBridge<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">497</span>)
  at java<span class="hljs-preprocessor">.io</span><span class="hljs-preprocessor">.FileOutputStream</span><span class="hljs-preprocessor">.write</span>(FileOutputStream<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">186</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.flushBytesLocked</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">334</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.flushLocked</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">355</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.appendLocked</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">303</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span><span class="hljs-preprocessor">.print</span>(FastPrintWriter<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">466</span>)
  - locked &lt;&#64;addr&#61;<span class="hljs-number">0x13c93200</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.FastPrintWriter</span>$DummyWriter)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStats</span>$HistoryPrinter<span class="hljs-preprocessor">.printNextItem</span>(BatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">3503</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStats</span><span class="hljs-preprocessor">.dumpHistoryLocked</span>(BatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">3915</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStats</span><span class="hljs-preprocessor">.dumpLocked</span>(BatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">3962</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStatsImpl</span><span class="hljs-preprocessor">.dumpLocked</span>(BatteryStatsImpl<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">8843</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.server</span><span class="hljs-preprocessor">.am</span><span class="hljs-preprocessor">.BatteryStatsService</span><span class="hljs-preprocessor">.dump</span>(BatteryStatsService<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">947</span>)
  - locked &lt;<span class="hljs-number">0x052efb00</span>&gt; (a <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.BatteryStatsImpl</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.dump</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">319</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.onTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">285</span>)
  at <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.internal</span><span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.IBatteryStats</span>$Stub<span class="hljs-preprocessor">.onTransact</span>(IBatteryStats<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">832</span>)
  at android<span class="hljs-preprocessor">.os</span><span class="hljs-preprocessor">.Binder</span><span class="hljs-preprocessor">.execTransact</span>(Binder<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">446</span>)</code></pre> 
<p>仔细看这个traces&#xff0c;再仔细看这个traces&#xff0c;原来它在做dumpsys batterystats的操作&#xff0c;这个操作是谁发起的&#xff1f; <br /> 赶紧ps查看一下所有的dumpsys&#xff0c;发现有两个&#xff0c;一个是Z状态&#xff0c;僵尸了&#xff0c;一个是S状态。</p> 
<p>Z状态&#xff1f;发生了啥&#xff1f;赶紧看看父进程是谁&#xff0c;发现是dumpstate&#xff0c;为啥dumpstate没有帮它儿子收尸&#xff1f;赶紧看代码&#xff1a; <br />
 <img src="https://img-blog.csdnimg.cn/a008c19f0ca042a3a25e4a752462bf1a.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="dumpstate" title="" /> <br />
 <img src="https://img-blog.csdnimg.cn/d91fd5f255904f89afcb05eba3884050.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="dumpstate的run_command" title="" /></p> 
<p>原来dumpstate起了dumpsys batterystats之后如果waitpid等待超时就会通过kill来发送SIGTERM优雅的结束dumpsys batterystats&#xff0c;但是貌似它忘记了一件事情&#xff0c;就是再次waitpid替儿子收尸。。。太大意了&#xff0c;导致儿子变成僵尸&#xff01;</p> 
<p>但是尽管如此&#xff0c;处于僵尸状态的进程已经把占用的资源已经释放掉了&#xff0c;其中就包括文件描述符&#xff0c;所以还是解释不了thread 84为啥被block&#xff1f;</p> 
<p>接着看dumpsys batterystats是如何调用system server去做dump操作的&#xff0c;继续看代码&#xff1a; <br />
 <img src="https://img-blog.csdnimg.cn/6fda6b86840148f59f257f944607aba6.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="dumpsys" title="" /></p> 
<p>原来dumpsys把STDOUT传递给了system server去dump batterystats&#xff0c;但是上面dumpsys已经释放了所有文件资源&#xff0c;并且传递的是STDOUT&#xff0c;不应该block system server的thread 84啊&#xff1f; <br /> 带着这个问题继续烧脑&#xff0c;看源码&#xff0c;发现dumpstate是bugreport通过set property起的&#xff0c;然后通过socket与dumpstate建立连接&#xff0c;bugreport读取这个socket中的数据并write到标准输出&#xff0c;而dumpstate又通过dup2把与bugreport的socket重定向到了stdout&#xff1a; <br /> <img src="https://img-blog.csdnimg.cn/bb0372f38c48436aa997ffe28c1a2681.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_17,color_FFFFFF,t_70,g_se,x_16" alt="bugreport" title="" /> <br />
<img src="https://img-blog.csdnimg.cn/4bf16641fce54a9fb913aa26e371ffc9.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_17,color_FFFFFF,t_70,g_se,x_16" alt="redirect" title="" /> <br />
<img src="https://img-blog.csdnimg.cn/6ea1e79f383c49a4b8e45cd4a76970a2.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="dup2" title="" /></p> 
<p>run_command是通过先fork然后在子进程中用execvp的方式执行的dumpsys batterystats&#xff0c;这样dumpsys batterystats就继承了dumpstate的stdout&#xff0c;对应的就是与bugreport通信的socket&#xff0c;所以就算dumpsys进程的stdout被关闭也只会对这个socket的引用计数减1&#xff0c;现在这个socket对应的引用计数还有2&#xff0c;分别是dumpstate进程自己以及system server&#xff0c;因此dumpsys的Z状态不会中断system server的thread 84&#xff0c;所以问题的关键还是在于thread 84在向这个socket同步写数据&#xff0c;但是socket的另一端没有读。</p> 
<p>我们知道socket的另一端是bugreport&#xff0c;但是它为什么没有及时的把socket中的数据读走呢&#xff1f;赶紧用debuggerd dump出来bugreport的调用栈&#xff0c;发现bugreport在往标准输出里面写数据的时候被block了&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">backtrace:</span>
    <span class="hljs-preprocessor">#00 pc 000000000005fca4  /system/lib64/libc.so (write&#43;4)</span>
    <span class="hljs-preprocessor">#01 pc 00000000000524dc  /system/lib64/libc.so (__swrite&#43;76)</span>
    <span class="hljs-preprocessor">#02 pc 00000000000509d8  /system/lib64/libc.so (__sfvwrite&#43;564)</span>
    <span class="hljs-preprocessor">#03 pc 0000000000050e30  /system/lib64/libc.so (fwrite&#43;188)</span>
    <span class="hljs-preprocessor">#04 pc 0000000000000960  /system/bin/bugreport (main&#43;192)</span>
    <span class="hljs-preprocessor">#05 pc 0000000000013504  /system/lib64/libc.so (__libc_init&#43;100)</span>
    <span class="hljs-preprocessor">#06 pc 0000000000000a18  /system/bin/bugreport</span></code></pre> 
<p>bugreport往标准输出里面写数据时为什么会被block&#xff1f;</p> 
<p>先通过ps看一下bugreport的父进程是谁&#xff0c;发现是monkey进程&#xff0c;那monkey进程为什么不把bugreport的输出读走&#xff1f;从上面我们知道monkey的主线程block在了dumpsys meminfo&#xff0c;看它的其他线程也没有调用bugreport的调用栈&#xff0c;那bugreport是怎么起来的&#xff1f;什么时候起来的&#xff1f;百思不得其解&#xff0c;通过一遍一遍的看代码以及出问题时sdcard没有空间的种种线索发现了以下可疑代码和一个推论&#xff1a; <br />
<img src="https://img-blog.csdnimg.cn/72d9d797ac4a45209c0e70b95eaee8bd.png?x-oss-process=,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAYW5kcm9pZEJleW9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="monkey" title="" /> <br /> monkey起bugreport的方式就是调用上面的commandLineReport函数&#xff0c;这个函数起了bugreport之后会通过同步pipe的方式读取bugreport的标准输出&#xff0c;正常情况下会一直读完&#xff0c;mRequestBugreport为true就会把这些数据写到sdcard指定的文件里。如果在向sdcard写入这些log数据的时候存储空间满了&#xff0c;就会发生IO exception&#xff0c;那么就会跳出readline的while循环&#xff0c;从而继续执行其他操作&#xff0c;导致bugreport在write的时候block&#xff0c;进一步导致system server的thread 84在write的时候block&#xff0c;因为bugreport无法读取socket中的数据。</p> 
<p>monkey主线程跳出readline的while循环之后继续执行&#xff0c;然后执行到了dumpsys meminfo的操作&#xff0c;上面ps出来的另外一个S状态的dumpsys的父进程就是monkey&#xff0c;由于system server的thread 84拿着dumpsys meminfo线程需要的锁&#xff0c;所以monkey主线程也被block了&#xff0c;monkey主线程block导致system server的watchdog调用systemNotResponding一直无法返回而无法继续kill system server。</p> 
<p>好了&#xff0c;分析到这里就回答完两个问题了&#xff0c;system server不被watchdog kill的原因&#xff0c;以及thread 84的同步socket的读端是谁也找到了&#xff0c;为什么不读的原因也找到了。</p> 
<h2 id="问题总结">五、问题总结</h2> 
<p>1、在发生问题时&#xff0c;通过进入到bugreport进程的proc的fd目录下&#xff0c;cat 1(stdout)整个系统就全部恢复了&#xff0c;原理如上</p> 
<p>2、通过dumpsys batterystats|more可以使system server被block而引发watchdog重启&#xff0c;原理就是上面的分析</p> 
<p>3、有测试的同学发现它们通过java代码写的模拟shell执行的调用logcat的代码时而有效&#xff0c;时而logcat起来之后没有响应&#xff0c;调用进程一直waitfor无法返回&#xff0c;原因就是它们调用的logcat命令在执行时有时手机里面的crash信息比较多导致同步pipe的buffer被用完&#xff0c;而他们的调用进程没有将同步pipe中的数据读出&#xff0c;导致logcat进程在同步写pipe的时候block&#xff0c;而他的调用进程一直在空waitfor&#xff0c;时而有效是因为手机里面crash信息比较少甚至没有&#xff0c;执行他这行代码后logcat进程不会因为数据太多而在write的时候被block&#xff0c;他们的具体代码如下&#xff1a;</p> 
<pre class="prettyprint"><code class="language-java hljs ">        String returnInfo &#61; Utils.SHELL(<span class="hljs-keyword">new</span> String[]{<!-- --><span class="hljs-string">&#34;sh&#34;</span>, <span class="hljs-string">&#34;-c&#34;</span>, <span class="hljs-string">&#34;logcat -d -s crashmonitor&#34;</span>});
        <span class="hljs-keyword">if</span>(returnInfo.contains(<span class="hljs-string">&#34;CRASH&#34;</span>) &#61;&#61; <span class="hljs-keyword">true</span>){
            Utils.LOG(<span class="hljs-string">&#34;Found crash.&#34;</span>);
            Utils.SHELL(<span class="hljs-keyword">new</span> String[]{<!-- --><span class="hljs-string">&#34;sh&#34;</span>, <span class="hljs-string">&#34;-c&#34;</span>, <span class="hljs-string">&#34;logcat -v time -d &gt; &#34;</span> &#43; Utils.WORK_PATH &#43; <span class="hljs-string">&#34;logcat_crash.txt&#34;</span>});
        }</code></pre> 
<pre class="prettyprint"><code class="language-java hljs ">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">SHELL</span>(String[] command){
        Process p &#61; <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">int</span> status &#61; <span class="hljs-number">0</span>;
        String text &#61; <span class="hljs-keyword">null</span>;
        BufferedInputStream in &#61; <span class="hljs-keyword">null</span>;
        BufferedReader resultReader  &#61; <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">try</span>{
            p &#61; Runtime.getRuntime().exec(command);
            status &#61; p.waitFor();
            <span class="hljs-keyword">if</span>(status !&#61; <span class="hljs-number">0</span>){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(String.format(<span class="hljs-string">&#34;Run shell command: %s,  status: %s&#34;</span>, command, status));
            }</code></pre> 
<p>可以看到调用“Runtime.getRuntime().exec(command);”之后直接waitfor了&#xff0c;没有管p的输出&#xff0c;正确的用法应该是&#xff1a;</p> 
<pre class="prettyprint"><code class="language-java hljs ">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">SHELL</span>(String[] command){
        Process p &#61; <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">int</span> status &#61; <span class="hljs-number">0</span>;
        String text &#61; <span class="hljs-keyword">null</span>;
        BufferedInputStream in &#61; <span class="hljs-keyword">null</span>;
        BufferedReader resultReader  &#61; <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">try</span>{
            p &#61; Runtime.getRuntime().exec(command);

            in &#61; <span class="hljs-keyword">new</span> BufferedInputStream(p.getInputStream());
            resultReader &#61; <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(in, <span class="hljs-string">&#34;UTF-8&#34;</span>));
            String line;
            <span class="hljs-keyword">while</span>((line &#61; resultReader.readLine()) !&#61; <span class="hljs-keyword">null</span>){
                text &#43;&#61; line &#43; <span class="hljs-string">&#34;\n&#34;</span>;
            }

            status &#61; p.waitFor();
            <span class="hljs-keyword">if</span>(status !&#61; <span class="hljs-number">0</span>){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(String.format(<span class="hljs-string">&#34;Run shell command: %s,  status: %s&#34;</span>, command, status));
            }
</code></pre> 