---
layout:     post
title:      ANR问题分析和原理学习
subtitle:   Application Not Responding
date:       2018-05-22
author:     duguma
header-img: img/article-bg.jpg
top: false
catalog: true
tags:
    - Android
    - 工具命令
---  

 <article class="baidu_pl">
        <div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-1a85854398.css">
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>1、概述</strong> <br /> ANR即Application Not Responding(应用程序无响应)&#xff0c;一般在ANR的时候会弹出一个应用无响应对话框&#xff0c;同时会候产生一个日志文件trace.txt&#xff0c;位于/data/anr/文件夹下面&#xff0c;trace文件是Android Davik虚拟机在收到异常终止信号时产生的&#xff0c;最常见的一个触发条件就是Android应用中产生了FC(force close)。由于该文件的产生是在DVM中的&#xff0c;所以只有运行DVM实例的进程才能产生该文件&#xff0c;也就是说只有Java代码才能产生该文件&#xff0c;App应用的Native层&#xff08;如Android Library、用c/c&#43;&#43;编译的库&#xff09;即使异常也不会产生ANR日志文件。我们可以通过ANR产生的traces日志文件分析应用在哪里产生了ANR&#xff0c;以此来有效解决应用中的ANR。</p> 
<p><strong>2、ANR产生的原因</strong></p> 
<p>只用当应用程序的UI线程响应超时才会引起ANR&#xff0c;超时原因一般有两种&#xff1a;</p> 
<p>1.当前的事件没有机会得到处理&#xff0c;例如UI线程正在响应另一个事件&#xff0c;当前事件由于某种原因被阻塞了。</p> 
<p>2.当前的事件正在被处理&#xff0c;但是由于好事太长没有能够及时完成</p> 
<p>根据ANR产生的原因不同&#xff0c;超时时间也不尽相同&#xff0c;从本质上讲&#xff0c;产生ANR的原因有三种&#xff0c;大致可以对应到Android中四大组件中的三个&#xff08;Activity、BroadcastReceive、Service&#xff09;</p> 
<p>第一种&#xff1a;KeyDispatchTimeout&#xff1a;最常见的一种类型&#xff0c;原因是View事件或者触摸事件在特定时间内&#xff08;5s&#xff09;无法得到响应</p> 
<p>第二种&#xff1a;BroadcastTimeout&#xff1a;BroadcastReceiver的onReceive函数运行在主线程&#xff0c;并在特定的时间内&#xff08;10s&#xff09;无法完成处理</p> 
<p>第三种&#xff1a;ServiceTimeout&#xff1a;Service的各个生命周期函数在特定时间内&#xff08;20s&#xff09;无法完成响应</p> 
<p><strong>3.典型的ANR场景</strong></p> 
<p>1)主线程频繁进行IO操作&#xff0c;比如读写文件或者数据库&#xff1b; <br /> 2)硬件操作如进行调用照相机或者录音等操作&#xff1b; <br /> 3)多线程操作的死锁&#xff0c;导致主线程等待超时&#xff1b; <br /> 4)主线程操作调用join()方法、sleep()方法或者wait()方法&#xff1b; <br /> 5)耗时动画/耗资源行为导致CPU负载过重 <br /> 6)system server中发生WatchDog ANR&#xff1b; <br /> 7)service binder的数量达到上限</p> 
<p><strong>4.ANR的定位和分析</strong></p> 
<p><strong>1&#xff09;Logcat分析</strong></p> 
<p>查询关键字(ANR|ActivityManager) <br /> <img src="https://img-blog.csdn.net/20180819193443682?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Zhbnh1ZG9uZ2dyZWF0/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA&#61;&#61;/dissolve/70" alt="这里写图片描述" title="" /></p> 
<pre class="prettyprint"><code class=" hljs avrasm">/system_process E/ActivityManager:
ANR <span class="hljs-keyword">in</span> admanager<span class="hljs-preprocessor">.lbjfan</span><span class="hljs-preprocessor">.com</span><span class="hljs-preprocessor">.anrdemo</span> (admanager<span class="hljs-preprocessor">.lbjfan</span><span class="hljs-preprocessor">.com</span><span class="hljs-preprocessor">.anrdemo</span>/<span class="hljs-preprocessor">.MainActivity</span>)
                                                             PID: <span class="hljs-number">12639</span>
                                                             Reason: Input dispatching timed <span class="hljs-keyword">out</span> (Waiting to send non-key event because the touched window has not finished processing certain input events that were delivered to it over <span class="hljs-number">500.0</span>ms ago.  Wait queue length: <span class="hljs-number">6.</span>  Wait queue head age: <span class="hljs-number">5841.3</span>ms.)
                                                             Load: <span class="hljs-number">13.28</span> / <span class="hljs-number">11.53</span> / <span class="hljs-number">9.48</span>
                                                             CPU usage from <span class="hljs-number">71228</span>ms to <span class="hljs-number">0</span>ms ago (<span class="hljs-number">1970</span>-<span class="hljs-number">03</span>-<span class="hljs-number">01</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span>:<span class="hljs-number">47.864</span> to <span class="hljs-number">1970</span>-<span class="hljs-number">03</span>-<span class="hljs-number">01</span> <span class="hljs-number">00</span>:<span class="hljs-number">09</span>:<span class="hljs-number">59.093</span>):
                                                               <span class="hljs-number">15</span>% <span class="hljs-number">920</span>/system_server: <span class="hljs-number">9.2</span>% user &#43; <span class="hljs-number">5.9</span>% kernel / faults: <span class="hljs-number">10139</span> minor <span class="hljs-number">285</span> major
                                                               <span class="hljs-number">8.2</span>% <span class="hljs-number">13985</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.mm</span>: <span class="hljs-number">6.5</span>% user &#43; <span class="hljs-number">1.6</span>% kernel / faults: <span class="hljs-number">35481</span> minor <span class="hljs-number">1879</span> major
                                                               <span class="hljs-number">0.1</span>% <span class="hljs-number">555</span>/fingerprintd: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">51</span> minor <span class="hljs-number">22</span> major
                                                               <span class="hljs-number">3.5</span>% <span class="hljs-number">266</span>/mmcqd/<span class="hljs-number">0</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">3.5</span>% kernel
                                                               <span class="hljs-number">3.2</span>% <span class="hljs-number">4424</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.qqdownloader</span>:daemon: <span class="hljs-number">1.7</span>% user &#43; <span class="hljs-number">1.5</span>% kernel / faults: <span class="hljs-number">12007</span> minor <span class="hljs-number">357</span> major
                                                               <span class="hljs-number">3.2</span>% <span class="hljs-number">430</span>/adbd: <span class="hljs-number">0.4</span>% user &#43; <span class="hljs-number">2.7</span>% kernel / faults: <span class="hljs-number">2002</span> minor
                                                               <span class="hljs-number">3.1</span>% <span class="hljs-number">135</span>/kswapd0: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">3.1</span>% kernel
                                                               <span class="hljs-number">1.8</span>% <span class="hljs-number">12271</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.mobileqq</span>: <span class="hljs-number">1.2</span>% user &#43; <span class="hljs-number">0.5</span>% kernel / faults: <span class="hljs-number">8799</span> minor <span class="hljs-number">580</span> major
                                                               <span class="hljs-number">1.6</span>% <span class="hljs-number">11695</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.cleanmaster</span><span class="hljs-preprocessor">.mguard</span>: <span class="hljs-number">1.5</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">9171</span> minor <span class="hljs-number">72</span> major
                                                               <span class="hljs-number">1.3</span>% <span class="hljs-number">13039</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.mm</span>:<span class="hljs-keyword">push</span>: <span class="hljs-number">0.9</span>% user &#43; <span class="hljs-number">0.3</span>% kernel / faults: <span class="hljs-number">9969</span> minor <span class="hljs-number">192</span> major
                                                               <span class="hljs-number">1.2</span>% <span class="hljs-number">4954</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.google</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.gms</span>: <span class="hljs-number">0.9</span>% user &#43; <span class="hljs-number">0.2</span>% kernel / faults: <span class="hljs-number">7546</span> minor <span class="hljs-number">209</span> major
                                                               <span class="hljs-number">1.1</span>% <span class="hljs-number">342</span>/logd: <span class="hljs-number">0.3</span>% user &#43; <span class="hljs-number">0.8</span>% kernel / faults: <span class="hljs-number">628</span> minor <span class="hljs-number">3</span> major
                                                               <span class="hljs-number">1.1</span>% <span class="hljs-number">1485</span>/kworker/u13:<span class="hljs-number">3</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">1.1</span>% kernel
                                                               <span class="hljs-number">1.1</span>% <span class="hljs-number">10</span>/rcu_preempt: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">1.1</span>% kernel
                                                               <span class="hljs-number">1.1</span>% <span class="hljs-number">12166</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.vending</span>: <span class="hljs-number">0.8</span>% user &#43; <span class="hljs-number">0.3</span>% kernel / faults: <span class="hljs-number">9897</span> minor <span class="hljs-number">380</span> major
                                                               <span class="hljs-number">1</span>% <span class="hljs-number">3846</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.qqmusic</span>:QQPlayerService: <span class="hljs-number">0.6</span>% user &#43; <span class="hljs-number">0.4</span>% kernel / faults: <span class="hljs-number">7354</span> minor <span class="hljs-number">485</span> major
                                                               <span class="hljs-number">1</span>% <span class="hljs-number">10486</span>/kworker/u13:<span class="hljs-number">4</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">1</span>% kernel
                                                               <span class="hljs-number">1</span>% <span class="hljs-number">11251</span>/kworker/u13:<span class="hljs-number">1</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">1</span>% kernel
                                                               <span class="hljs-number">1</span>% <span class="hljs-number">9498</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.cleanmaster</span><span class="hljs-preprocessor">.security</span>:DefendService: <span class="hljs-number">0.7</span>% user &#43; <span class="hljs-number">0.3</span>% kernel / faults: <span class="hljs-number">11998</span> minor <span class="hljs-number">287</span> major
                                                               <span class="hljs-number">0.9</span>% <span class="hljs-number">1973</span>/kworker/u13:<span class="hljs-number">5</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.9</span>% kernel
                                                               <span class="hljs-number">0.9</span>% <span class="hljs-number">14113</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.mm</span>:exdevice: <span class="hljs-number">0.7</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">8802</span> minor <span class="hljs-number">142</span> major
                                                               <span class="hljs-number">0.8</span>% <span class="hljs-number">10814</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.qqmusic</span>: <span class="hljs-number">0.4</span>% user &#43; <span class="hljs-number">0.4</span>% kernel / faults: <span class="hljs-number">9823</span> minor <span class="hljs-number">221</span> major
                                                               <span class="hljs-number">0.8</span>% <span class="hljs-number">2062</span>/sogou<span class="hljs-preprocessor">.mobile</span><span class="hljs-preprocessor">.explorer</span>: <span class="hljs-number">0.5</span>% user &#43; <span class="hljs-number">0.3</span>% kernel / faults: <span class="hljs-number">8532</span> minor <span class="hljs-number">1288</span> major
                                                               <span class="hljs-number">0.8</span>% <span class="hljs-number">528</span>/netd: <span class="hljs-number">0.1</span>% user &#43; <span class="hljs-number">0.7</span>% kernel / faults: <span class="hljs-number">4203</span> minor <span class="hljs-number">35</span> major
                                                               <span class="hljs-number">0.8</span>% <span class="hljs-number">3925</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.google</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.gms</span><span class="hljs-preprocessor">.persistent</span>: <span class="hljs-number">0.4</span>% user &#43; <span class="hljs-number">0.3</span>% kernel / faults: <span class="hljs-number">12578</span> minor <span class="hljs-number">546</span> major
                                                               <span class="hljs-number">0.7</span>% <span class="hljs-number">556</span>/cnss_diag: <span class="hljs-number">0.6</span>% user &#43; <span class="hljs-number">0</span>% kernel / faults: <span class="hljs-number">121</span> minor <span class="hljs-number">5</span> major
                                                               <span class="hljs-number">0.6</span>% <span class="hljs-number">4971</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.cleanmaster</span><span class="hljs-preprocessor">.mguard</span>:service: <span class="hljs-number">0.4</span>% user &#43; <span class="hljs-number">0.2</span>% kernel / faults: <span class="hljs-number">7468</span> minor <span class="hljs-number">174</span> major
                                                               <span class="hljs-number">0.5</span>% <span class="hljs-number">9180</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.qqdownloader</span>: <span class="hljs-number">0.2</span>% user &#43; <span class="hljs-number">0.3</span>% kernel / faults: <span class="hljs-number">9571</span> minor <span class="hljs-number">216</span> major
                                                               <span class="hljs-number">0.5</span>% <span class="hljs-number">15</span>/ksoftirqd/<span class="hljs-number">1</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.5</span>% kernel
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">3280</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.phone</span>: <span class="hljs-number">0.2</span>% user &#43; <span class="hljs-number">0.2</span>% kernel / faults: <span class="hljs-number">1857</span> minor <span class="hljs-number">133</span> major
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">8489</span>/kworker/<span class="hljs-number">0</span>:<span class="hljs-number">1</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.4</span>% kernel
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">3127</span>/sdcard: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.4</span>% kernel / faults: <span class="hljs-number">92</span> minor <span class="hljs-number">17</span> major
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">397</span>/servicemanager: <span class="hljs-number">0.1</span>% user &#43; <span class="hljs-number">0.2</span>% kernel / faults: <span class="hljs-number">127</span> minor
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">11878</span>/swift<span class="hljs-preprocessor">.space</span><span class="hljs-preprocessor">.cleaner</span><span class="hljs-preprocessor">.free</span>:service: <span class="hljs-number">0.2</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">6087</span> minor <span class="hljs-number">140</span> major
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">20</span>/ksoftirqd/<span class="hljs-number">2</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.4</span>% kernel
                                                               <span class="hljs-number">0.4</span>% <span class="hljs-number">8761</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.netease</span><span class="hljs-preprocessor">.cloudmusic</span>:play: <span class="hljs-number">0.3</span>% user &#43; <span class="hljs-number">0</span>% kernel / faults: <span class="hljs-number">4819</span> minor <span class="hljs-number">977</span> major
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">6525</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.qqlive</span>:services: <span class="hljs-number">0.2</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">7834</span> minor <span class="hljs-number">483</span> major
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">12250</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.tencent</span><span class="hljs-preprocessor">.mobileqq</span>:MSF: <span class="hljs-number">0.2</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">5368</span> minor <span class="hljs-number">114</span> major
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">9717</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.speed</span><span class="hljs-preprocessor">.boost</span><span class="hljs-preprocessor">.booster</span>:service: <span class="hljs-number">0.1</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">5526</span> minor <span class="hljs-number">77</span> major
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">8524</span>/sogou<span class="hljs-preprocessor">.mobile</span><span class="hljs-preprocessor">.explorer</span>:push_service: <span class="hljs-number">0.2</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">6280</span> minor <span class="hljs-number">42</span> major
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">427</span>/irq/<span class="hljs-number">215</span>-fc38800: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.3</span>% kernel
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">8721</span>/kworker/<span class="hljs-number">1</span>:<span class="hljs-number">2</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.3</span>% kernel
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">260</span>/cfinteractive: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.3</span>% kernel
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">294</span>/msm-core:sampli: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.3</span>% kernel
                                                               <span class="hljs-number">0.1</span>% <span class="hljs-number">8756</span>/kworker/u12:<span class="hljs-number">3</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.1</span>% kernel
                                                               <span class="hljs-number">0.1</span>% <span class="hljs-number">11204</span>/kworker/<span class="hljs-number">2</span>:<span class="hljs-number">0</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.1</span>% kernel
                                                               <span class="hljs-number">0.3</span>% <span class="hljs-number">3150</span>/<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.android</span><span class="hljs-preprocessor">.systemui</span>: <span class="hljs-number">0.1</span>% user &#43; <span class="hljs-number">0.1</span>% kernel / faults: <span class="hljs-number">3318</span> minor <span class="hljs-number">129</span> major
                                                               <span class="hljs-number">0.2</span>% <span class="hljs-number">7244</span>/kworker/u12:<span class="hljs-number">2</span>: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0.2</span>% kernel
                                                               <span class="hljs-number">0</span>% <span class="hljs-number">3084</span>/VosMCThread: <span class="hljs-number">0</span>% user &#43; <span class="hljs-number">0</span>% kerne</code></pre> 
<p>可以看到&#xff0c;Logcat日志信息中主要包含如下内容&#xff1a;</p> 
<p>1&#xff09;导致ANR的类名及所在包名&#xff1a; <br /> admanager.lbjfan.com.anrdemo (admanager.lbjfan.com.anrdemo/.MainActivity)</p> 
<p>2&#xff09;导致ANR的进程名及ID&#xff1a;admanager.lbjfan.com.anrdemo&#xff0c;12639</p> 
<p>3&#xff09;ANR产生的原因(类型)&#xff1a;Reason: Input dispatching timed out (Waiting to send non-key event because the touched window has not finished processing certain input events that were delivered to it over 500.0ms ago. Wait queue length: 6. Wait queue head age: 5841.3ms.)&#xff0c;明显属于KeyDispatchTimeout类型。</p> 
<p>4&#xff09;系统中CPU使用率的统计信息及某段时间内的变换情况</p> 
<p><strong>2&#xff09;.从trace.txt文件分析</strong></p> 
<p>ANR Logcat信息可以帮助我们分析引发ANR的具体类的信息以及ANR的类型&#xff0c;但是却无法帮助我们定位到具体引发问题的代码行&#xff0c;这时候就需要借助ANR发生过程中生成的堆栈信息文件data/anr/trace.txt</p> 
<p>获取trace文件&#xff1a;adb pull /data/anr/trace.txt</p> 
<p>trace.txt文件分析</p> 
<p>由于trace文件记录的是整个手机的ANR日志&#xff0c;所以我们需要根据进程名&#xff08;包名&#xff09;和ANR发生的时间找到对应日志&#xff0c;具体以pid 进程id开始&#xff0c;以pid进程id结束。由于阻塞始终会发生在主线程&#xff0c;因此我们需要关注 <br /> 线程名为main的线程状态。下面摘出一部分关键日志进行分析&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs livecodeserver">//关键日志的起始标记
<span class="hljs-comment">----- pid 20678 at 2018-08-13 21:58:59 -----</span><span class="hljs-comment">
//应用程序包名</span>
Cmd <span class="hljs-built_in">line</span>: admanager.lbjfan.com.anrdemo
Build fingerprint: <span class="hljs-string">&#39;Android/aosp_bullhead/bullhead:7.1.2/N2G48C/han-li03221443:userdebug/test-keys&#39;</span>
<span class="hljs-comment">
//手机的CPU架构</span>
ABI: <span class="hljs-string">&#39;arm64&#39;</span>
<span class="hljs-comment">
//堆内存信息</span>
Heap: <span class="hljs-number">33</span>% free, <span class="hljs-number">4</span>MB/<span class="hljs-number">6</span>MB; <span class="hljs-number">27144</span> objects
Dumping cumulative Gc timings

Total <span class="hljs-built_in">time</span> spent <span class="hljs-operator">in</span> GC: <span class="hljs-number">10.680</span>ms
Mean GC size throughput: <span class="hljs-number">68</span>MB/s
Mean GC object throughput: <span class="hljs-number">1.32996e&#43;06</span> objects/s
Total <span class="hljs-built_in">number</span> <span class="hljs-operator">of</span> allocations <span class="hljs-number">41348</span>
Total <span class="hljs-keyword">bytes</span> allocated <span class="hljs-number">5</span>MB
Total <span class="hljs-keyword">bytes</span> freed <span class="hljs-number">753</span>KB
<span class="hljs-comment">
//手机Memory内存信息</span>
Free memory <span class="hljs-number">2</span>MB
Free memory <span class="hljs-keyword">until</span> GC <span class="hljs-number">2</span>MB
Free memory <span class="hljs-keyword">until</span> OOME <span class="hljs-number">187</span>MB
Total memory <span class="hljs-number">6</span>MB
Max memory <span class="hljs-number">192</span>MB
Zygote <span class="hljs-constant">space</span> size <span class="hljs-number">1128</span>KB
Total mutator paused <span class="hljs-built_in">time</span>: <span class="hljs-number">463</span>us
Total <span class="hljs-built_in">time</span> waiting <span class="hljs-keyword">for</span> GC <span class="hljs-built_in">to</span> complete: <span class="hljs-number">938</span>ns
Total GC count: <span class="hljs-number">1</span>
Total GC <span class="hljs-built_in">time</span>: <span class="hljs-number">10.680</span>ms
Total blocking GC count: <span class="hljs-number">0</span>
Total blocking GC <span class="hljs-built_in">time</span>: <span class="hljs-number">0</span>
<span class="hljs-comment">
//主线程日志分析</span><span class="hljs-comment">
//基本信息&#xff1a;main-线程名称&#xff0c;prio-线程优先级&#xff0c;tid-线程id&#xff0c;Sleeping-线程状态</span>
<span class="hljs-string">&#34;main&#34;</span> prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">1</span> Sleeping
 <span class="hljs-comment"> //详细信息&#xff1a;group-线程组名称&#xff0c;sCount-线程被挂起的次数&#xff0c;dsCount-线程被调试器刮起的次数&#xff0c;obj-线程的Java对象地址&#xff0c;self-线程本身的Native对象地址</span>
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> <span class="hljs-variable">sCount</span>&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x75190ed0</span> self&#61;<span class="hljs-number">0x7f72095a00</span>
 <span class="hljs-comment"> //线程的调度信息&#xff1a;sysTid-linux系统中内核线程id&#xff08;观察发现主线程的线程号和进程号相同&#xff09;&#xff0c;nice-线程调度的优先级&#xff0c;cgrp-线程调度组&#xff0c;sched-线程调度策略和优先级&#xff0c;handle-线程处理函数地址</span>
  | sysTid&#61;<span class="hljs-number">20678</span> nice&#61;-<span class="hljs-number">10</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f75fe0a98</span>
 <span class="hljs-comment"> //上下文信息&#xff1a;state-线程调度状态&#xff0c;schedstat-线程在CPU中的执行时间、线程等待时间、线程执行的时间片长度&#xff0c;utm-线程在用户状态中调度的时间值&#xff0c;core-最后执行这个线程的CPU核序号</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">274637713</span> <span class="hljs-number">30817705</span> <span class="hljs-number">229</span> ) utm&#61;<span class="hljs-number">20</span> stm&#61;<span class="hljs-number">6</span> core&#61;<span class="hljs-number">1</span> HZ&#61;<span class="hljs-number">100</span>
 <span class="hljs-comment"> //堆栈信息&#xff1a;stack-堆栈地址&#xff0c;stackSize-堆栈大小&#xff0c;余下的为堆栈信息&#xff0c;也是我们分析引发ANR问题的关键</span>
  | stack&#61;<span class="hljs-number">0x7fc8318000</span>-<span class="hljs-number">0x7fc831a000</span> stackSize&#61;<span class="hljs-number">8</span>MB
  | held mutexes&#61;
  <span class="hljs-keyword">at</span> java.lang.Thread.sleep!(Native method)
  - sleeping <span class="hljs-command"><span class="hljs-keyword">on</span> &lt;<span class="hljs-title">0x02f69763</span>&gt; (<span class="hljs-title">a</span> <span class="hljs-title">java</span>.<span class="hljs-title">lang</span>.<span class="hljs-title">Object</span>)</span>
  <span class="hljs-keyword">at</span> java.lang.Thread.sleep(Thread.java:<span class="hljs-number">371</span>)
  - locked &lt;<span class="hljs-number">0x02f69763</span>&gt; (<span class="hljs-operator">a</span> java.lang.Object)
  <span class="hljs-keyword">at</span> java.lang.Thread.sleep(Thread.java:<span class="hljs-number">313</span>)
  <span class="hljs-keyword">at</span> admanager.lbjfan.com.anrdemo.MainActivity$<span class="hljs-number">1.</span>onClick(MainActivity.java:<span class="hljs-number">24</span>)
  <span class="hljs-keyword">at</span> android.view.View.performClick(View.java:<span class="hljs-number">5637</span>)
  <span class="hljs-keyword">at</span> android.view.View$PerformClick.run(View.java:<span class="hljs-number">22429</span>)
  <span class="hljs-keyword">at</span> android.os.Handler.handleCallback(Handler.java:<span class="hljs-number">751</span>)
  <span class="hljs-keyword">at</span> android.os.Handler.dispatchMessage(Handler.java:<span class="hljs-number">95</span>)
  <span class="hljs-keyword">at</span> android.os.Looper.loop(Looper.java:<span class="hljs-number">154</span>)
  <span class="hljs-keyword">at</span> android.app.ActivityThread.main(ActivityThread.java:<span class="hljs-number">6121</span>)
  <span class="hljs-keyword">at</span> java.lang.reflect.Method.invoke!(Native method)
  <span class="hljs-keyword">at</span> com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="hljs-number">889</span>)
  <span class="hljs-keyword">at</span> com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="hljs-number">779</span>)

<span class="hljs-string">&#34;Jit thread pool worker thread 0&#34;</span> daemon prio&#61;<span class="hljs-number">5</span> tid&#61;<span class="hljs-number">2</span> Native
  | group&#61;<span class="hljs-string">&#34;main&#34;</span> <span class="hljs-variable">sCount</span>&#61;<span class="hljs-number">1</span> dsCount&#61;<span class="hljs-number">0</span> obj&#61;<span class="hljs-number">0x12c64790</span> self&#61;<span class="hljs-number">0x7f6a635000</span>
  | sysTid&#61;<span class="hljs-number">20683</span> nice&#61;<span class="hljs-number">9</span> cgrp&#61;default sched&#61;<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle&#61;<span class="hljs-number">0x7f71701450</span>
  | state&#61;S schedstat&#61;( <span class="hljs-number">696978</span> <span class="hljs-number">5677</span> <span class="hljs-number">2</span> ) utm&#61;<span class="hljs-number">0</span> stm&#61;<span class="hljs-number">0</span> core&#61;<span class="hljs-number">2</span> HZ&#61;<span class="hljs-number">100</span>
  | stack&#61;<span class="hljs-number">0x7f71603000</span>-<span class="hljs-number">0x7f71605000</span> stackSize&#61;<span class="hljs-number">1021</span>KB
  | held mutexes&#61;
  kernel: __switch_to&#43;<span class="hljs-number">0x8c</span>/<span class="hljs-number">0x98</span>
  kernel: futex_wait_queue_me&#43;<span class="hljs-number">0xd4</span>/<span class="hljs-number">0x130</span>
  kernel: futex_wait&#43;<span class="hljs-number">0xfc</span>/<span class="hljs-number">0x210</span>
  kernel: do_futex&#43;<span class="hljs-number">0xe0</span>/<span class="hljs-number">0x920</span>
  kernel: SyS_futex&#43;<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x1b0</span>
  kernel: cpu_switch_to&#43;<span class="hljs-number">0x48</span>/<span class="hljs-number">0x4c</span>
  native: <span class="hljs-comment">#00 pc 000000000001bcec  /system/lib64/libc.so (syscall&#43;28)</span>
  native: <span class="hljs-comment">#01 pc 00000000000e7e4c  /system/lib64/libart.so (_ZN3art17ConditionVariable16WaitHoldingLocksEPNS_6ThreadE&#43;156)</span>
  native: <span class="hljs-comment">#02 pc 000000000046c910  /system/lib64/libart.so (_ZN3art10ThreadPool7GetTaskEPNS_6ThreadE&#43;248)</span>
  native: <span class="hljs-comment">#03 pc 000000000046bdac  /system/lib64/libart.so (_ZN3art16ThreadPoolWorker3RunEv&#43;124)</span>
  native: <span class="hljs-comment">#04 pc 000000000046b6d0  /system/lib64/libart.so (_ZN3art16ThreadPoolWorker8CallbackEPv&#43;132)</span>
  native: <span class="hljs-comment">#05 pc 0000000000068734  /system/lib64/libc.so (_ZL15__pthread_startPv&#43;208)</span>
  native: <span class="hljs-comment">#06 pc 000000000001da7c  /system/lib64/libc.so (__start_thread&#43;16)</span>
  (no managed stack frames)
<span class="hljs-comment">
//关键日志的结束标记</span>
<span class="hljs-comment">----- end 20678 -----</span>
</code></pre> 
<p>由于ANR只会发生在主线程&#xff0c;所以我们需要关注主线程的状态&#xff0c;从上 面日志中分析可以知道&#xff1a;发生ANR时主线程的状态为Sleep&#xff0c;且引起该状态的地方在MainActivity$1.onClick(MainActivity.java:24) <br /> <img src="https://img-blog.csdn.net/20180819193529138?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Zhbnh1ZG9uZ2dyZWF0/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA&#61;&#61;/dissolve/70" alt="这里写图片描述" title="" /></p> 
<p><strong>3&#xff09;使用AndroidStudio分析工具</strong></p> 
<p>有时候查看trace文件是及其困难的&#xff0c;很难定位到具体的代码位置&#xff0c;这时候就可以借助AndroidStudio提供的工具&#xff1a;Analyze-AnalyzeStacktrace&#xff0c;然后添加得到的trace&#xff0c;如下&#xff1a;<img src="https://img-blog.csdn.net/2018081919334586?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Zhbnh1ZG9uZ2dyZWF0/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA&#61;&#61;/dissolve/70" alt="这里写图片描述" title="" /></p> 
<p><strong>5.ANR源码分析</strong></p> 
<p>下面分析Service内onCreate发生ANR异常时源代码的执行情况</p> 
<p>大家都知道Android中的四大组件启动时&#xff0c;都会通过跨进程的方式利用Handler消息机制最终将消息Push到ActivityThread中的内部类去处理&#xff0c;因此我先在ActivityThread中搜索service.onCreate调用&#xff0c;然后依次追溯&#xff1a;</p> 
<p>注&#xff1a;下面均以删除无关代码</p> 
<p>ActivityThread中调用&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs cs">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleCreateService</span>(CreateServiceData data) {
            <span class="hljs-comment">//调用service的onCreate</span>
            service.onCreate();

    }</code></pre> 
<p>该方法由Activity的内部类H&#xff08;继承与Handler&#xff09;接收到Servic onCreate消息时调用&#xff0c;该消息由通过scheduleCreateService发出&#xff0c;该方法被ActiveService类调用</p> 
<pre class="prettyprint"><code class=" hljs java">        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scheduleCreateService</span>(IBinder token,
                ServiceInfo info, CompatibilityInfo compatInfo, <span class="hljs-keyword">int</span> processState) {
            updateProcessState(processState, <span class="hljs-keyword">false</span>);
            CreateServiceData s &#61; <span class="hljs-keyword">new</span> CreateServiceData();
            s.token &#61; token;
            s.info &#61; info;
            s.compatInfo &#61; compatInfo;

            sendMessage(H.CREATE_SERVICE, s);
        }</code></pre> 
<p>ActiveServicde的realStartServiceLocked方法调用上面方法&#xff0c;这个方法比较关键需要认真分析&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">realStartServiceLocked</span>(ServiceRecord r,
            ProcessRecord app, <span class="hljs-keyword">boolean</span> execInFg) <span class="hljs-keyword">throws</span> RemoteException {

        r.app &#61; app;
        r.restartTime &#61; r.lastActivity &#61; SystemClock.uptimeMillis();

        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> newService &#61; app.services.add(r);
        <span class="hljs-comment">//发送delay消息(SERVICE_TIMEOUT_MSG)</span>
        bumpServiceExecutingLocked(r, execInFg, <span class="hljs-string">&#34;create&#34;</span>);
        mAm.updateLruProcessLocked(app, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
        updateServiceForegroundLocked(r.app, <span class="hljs-comment">/* oomAdj&#61; */</span> <span class="hljs-keyword">false</span>);
        mAm.updateOomAdjLocked();

        <span class="hljs-keyword">boolean</span> created &#61; <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">synchronized</span> (r.stats.getBatteryStats()) {
                r.stats.startLaunchedLocked();
            }
            mAm.notifyPackageUse(r.serviceInfo.packageName,
                                 PackageManager.NOTIFY_PACKAGE_USE_SERVICE);
            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);
            <span class="hljs-comment">//最终执行服务的onCreate()方法</span>
            app.thread.scheduleCreateService(r, r.serviceInfo,
                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),
                    app.repProcState);
            r.postNotification();
            created &#61; <span class="hljs-keyword">true</span>;
        } <span class="hljs-keyword">catch</span> (DeadObjectException e) {
            Slog.w(TAG, <span class="hljs-string">&#34;Application dead when creating service &#34;</span> &#43; r);
            mAm.appDiedLocked(app);
            <span class="hljs-keyword">throw</span> e;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (!created) {
                <span class="hljs-comment">// Keep the executeNesting count accurate.</span>
                <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> inDestroying &#61; mDestroyingServices.contains(r);
                <span class="hljs-comment">//当service启动完毕&#xff0c;则remove SERVICE_TIMEOUT_MSG消息</span>
                serviceDoneExecutingLocked(r, inDestroying, inDestroying);

                <span class="hljs-comment">// Cleanup.</span>
                <span class="hljs-keyword">if</span> (newService) {
                    app.services.remove(r);
                    r.app &#61; <span class="hljs-keyword">null</span>;
                }

                <span class="hljs-comment">// Retry.</span>
                <span class="hljs-keyword">if</span> (!inDestroying) {
                    scheduleServiceRestartLocked(r, <span class="hljs-keyword">false</span>);
                }
            }
        }

        <span class="hljs-keyword">if</span> (r.whitelistManager) {
            app.whitelistManager &#61; <span class="hljs-keyword">true</span>;
        }

        requestServiceBindingsLocked(r, execInFg);

        updateServiceClientActivitiesLocked(app, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">true</span>);

        <span class="hljs-comment">// If the service is in the started state, and there are no</span>
        <span class="hljs-comment">// pending arguments, then fake up one so its onStartCommand() will</span>
        <span class="hljs-comment">// be called.</span>
        <span class="hljs-keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() &#61;&#61; <span class="hljs-number">0</span>) {
            r.pendingStarts.add(<span class="hljs-keyword">new</span> ServiceRecord.StartItem(r, <span class="hljs-keyword">false</span>, r.makeNextStartId(),
                    <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">0</span>));
        }

        sendServiceArgsLocked(r, execInFg, <span class="hljs-keyword">true</span>);
    }</code></pre> 
<p>bumpServiceExecutingLocked方法内又调用了scheduleServiceTimeoutLocked方法&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs avrasm">    void scheduleServiceForegroundTransitionTimeoutLocked(ServiceRecord r) {
        if (r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.executingServices</span><span class="hljs-preprocessor">.size</span>() &#61;&#61; <span class="hljs-number">0</span> || r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.thread</span> &#61;&#61; null) {
            return<span class="hljs-comment">;</span>
        }
        //指定id为SERVICE_TIMEOUT_MSG的消息
        Message msg &#61; mAm<span class="hljs-preprocessor">.mHandler</span><span class="hljs-preprocessor">.obtainMessage</span>(
                ActivityManagerService<span class="hljs-preprocessor">.SERVICE</span>_FOREGROUND_TIMEOUT_MSG)<span class="hljs-comment">;</span>
        msg<span class="hljs-preprocessor">.obj</span> &#61; r<span class="hljs-comment">;</span>
        r<span class="hljs-preprocessor">.fgWaiting</span> &#61; true<span class="hljs-comment">;</span>
        //前台Service和后台Service发送的Delay消息时间不同
        mAm<span class="hljs-preprocessor">.mHandler</span><span class="hljs-preprocessor">.sendMessageDelayed</span>(msg, SERVICE_START_FOREGROUND_TIMEOUT)<span class="hljs-comment">;</span>
    }</code></pre> 
<p>serviceDoneExecutingLocked方法</p> 
<pre class="prettyprint"><code class=" hljs avrasm">    private void serviceDoneExecutingLocked(ServiceRecord r, boolean inDestroying,
            boolean finishing) {
        r<span class="hljs-preprocessor">.executeNesting</span>--<span class="hljs-comment">;</span>
        if (r<span class="hljs-preprocessor">.executeNesting</span> &lt;&#61; <span class="hljs-number">0</span>) {
            if (r<span class="hljs-preprocessor">.app</span> !&#61; null) {
                if (DEBUG_SERVICE) Slog<span class="hljs-preprocessor">.v</span>(TAG_SERVICE,
                        <span class="hljs-string">&#34;Nesting at 0 of &#34;</span> &#43; r<span class="hljs-preprocessor">.shortName</span>)<span class="hljs-comment">;</span>
                r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.execServicesFg</span> &#61; false<span class="hljs-comment">;</span>
                r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.executingServices</span><span class="hljs-preprocessor">.remove</span>(r)<span class="hljs-comment">;</span>
                if (r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.executingServices</span><span class="hljs-preprocessor">.size</span>() &#61;&#61; <span class="hljs-number">0</span>) {
                    if (DEBUG_SERVICE || DEBUG_SERVICE_EXECUTING) Slog<span class="hljs-preprocessor">.v</span>(TAG_SERVICE_EXECUTING,
                            <span class="hljs-string">&#34;No more executingServices of &#34;</span> &#43; r<span class="hljs-preprocessor">.shortName</span>)<span class="hljs-comment">;</span>
                   //remove掉id为SERVICE_TIMEOUT_MSG的消息&#xff0c;从上面的分析可知&#xff0c;该方法是onCreate调用之前发出的一个Delay执行的消息
                   mAm<span class="hljs-preprocessor">.mHandler</span><span class="hljs-preprocessor">.removeMessages</span>(ActivityManagerService<span class="hljs-preprocessor">.SERVICE</span>_TIMEOUT_MSG, r<span class="hljs-preprocessor">.app</span>)<span class="hljs-comment">;</span>
                } else if (r<span class="hljs-preprocessor">.executeFg</span>) {
                    // Need to re-evaluate whether the app still needs to be <span class="hljs-keyword">in</span> the foreground.
                    for (int i&#61;r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.executingServices</span><span class="hljs-preprocessor">.size</span>()-<span class="hljs-number">1</span><span class="hljs-comment">; i&gt;&#61;0; i--) {<!-- --></span>
                        if (r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.executingServices</span><span class="hljs-preprocessor">.valueAt</span>(i)<span class="hljs-preprocessor">.executeFg</span>) {
                            r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.execServicesFg</span> &#61; true<span class="hljs-comment">;</span>
                            <span class="hljs-keyword">break</span><span class="hljs-comment">;</span>
                        }
                    }
                }
                if (inDestroying) {
                    mDestroyingServices<span class="hljs-preprocessor">.remove</span>(r)<span class="hljs-comment">;</span>
                    r<span class="hljs-preprocessor">.bindings</span><span class="hljs-preprocessor">.clear</span>()<span class="hljs-comment">;</span>
                }
                mAm<span class="hljs-preprocessor">.updateOomAdjLocked</span>(r<span class="hljs-preprocessor">.app</span>, true)<span class="hljs-comment">;</span>
            }
            r<span class="hljs-preprocessor">.executeFg</span> &#61; false<span class="hljs-comment">;</span>
            if (r<span class="hljs-preprocessor">.tracker</span> !&#61; null) {
                r<span class="hljs-preprocessor">.tracker</span><span class="hljs-preprocessor">.setExecuting</span>(false, mAm<span class="hljs-preprocessor">.mProcessStats</span><span class="hljs-preprocessor">.getMemFactorLocked</span>(),
                        SystemClock<span class="hljs-preprocessor">.uptimeMillis</span>())<span class="hljs-comment">;</span>
                if (finishing) {
                    r<span class="hljs-preprocessor">.tracker</span><span class="hljs-preprocessor">.clearCurrentOwner</span>(r, false)<span class="hljs-comment">;</span>
                    r<span class="hljs-preprocessor">.tracker</span> &#61; null<span class="hljs-comment">;</span>
                }
            }
            if (finishing) {
                if (r<span class="hljs-preprocessor">.app</span> !&#61; null &amp;&amp; !r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.persistent</span>) {
                    r<span class="hljs-preprocessor">.app</span><span class="hljs-preprocessor">.services</span><span class="hljs-preprocessor">.remove</span>(r)<span class="hljs-comment">;</span>
                    if (r<span class="hljs-preprocessor">.whitelistManager</span>) {
                        updateWhitelistManagerLocked(r<span class="hljs-preprocessor">.app</span>)<span class="hljs-comment">;</span>
                    }
                }
                r<span class="hljs-preprocessor">.app</span> &#61; null<span class="hljs-comment">;</span>
            }
        }
    }</code></pre> 
<p>小结&#xff1a;Service启动调用onCreate方法之前send一个Delay执行的消息&#xff0c;当发生异常或者Service的onCreate方法执行完毕之后&#xff0c;remove掉之前send的消息&#xff0c;如果onCreate方法执行时间超过Delay的时间&#xff0c;那么该消息就会被处理&#xff0c;此时如果Delay的时间是我们设定的ANR时间&#xff0c;则发生ANR&#xff0c;系统作出处理&#xff0c;否则该消息被remove&#xff0c;不会被执行。以一种观察者模式的角度去实现。</p> 
<p>id为SERVICE_TIMEOUT_MSG的消息被AMS中MainHandler接收</p> 
<pre class="prettyprint"><code class=" hljs avrasm">            case SERVICE_TIMEOUT_MSG: {
                if (mDidDexOpt) {
                    mDidDexOpt &#61; false<span class="hljs-comment">;</span>
                    Message nmsg &#61; mHandler<span class="hljs-preprocessor">.obtainMessage</span>(SERVICE_TIMEOUT_MSG)<span class="hljs-comment">;</span>
                    nmsg<span class="hljs-preprocessor">.obj</span> &#61; msg<span class="hljs-preprocessor">.obj</span><span class="hljs-comment">;</span>
                    mHandler<span class="hljs-preprocessor">.sendMessageDelayed</span>(nmsg, ActiveServices<span class="hljs-preprocessor">.SERVICE</span>_TIMEOUT)<span class="hljs-comment">;</span>
                    return<span class="hljs-comment">;</span>
                }
                mServices<span class="hljs-preprocessor">.serviceTimeout</span>((ProcessRecord)msg<span class="hljs-preprocessor">.obj</span>)<span class="hljs-comment">;</span>
            } <span class="hljs-keyword">break</span><span class="hljs-comment">;</span></code></pre> 
<p>ActiveService的serviceTimeout方法中调用AppErrors中的appNotResponding方法&#xff0c;很明显ANR异常处理的方法&#xff1a;</p> 
<pre class="prettyprint"><code class=" hljs java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> appNotResponding(ProcessRecord app, ActivityRecord activity,
            ActivityRecord parent, <span class="hljs-keyword">boolean</span> aboveSystem, <span class="hljs-keyword">final</span> String annotation) {
        ArrayList&lt;Integer&gt; firstPids &#61; <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;(<span class="hljs-number">5</span>);
        SparseArray&lt;Boolean&gt; lastPids &#61; <span class="hljs-keyword">new</span> SparseArray&lt;Boolean&gt;(<span class="hljs-number">20</span>);

        <span class="hljs-keyword">if</span> (mService.mController !&#61; <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 0 &#61;&#61; continue, -1 &#61; kill process immediately</span>
                <span class="hljs-keyword">int</span> res &#61; mService.mController.appEarlyNotResponding(
                        app.processName, app.pid, annotation);
                <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span> &amp;&amp; app.pid !&#61; MY_PID) {
                    app.kill(<span class="hljs-string">&#34;anr&#34;</span>, <span class="hljs-keyword">true</span>);
                }
            } <span class="hljs-keyword">catch</span> (RemoteException e) {
                mService.mController &#61; <span class="hljs-keyword">null</span>;
                Watchdog.getInstance().setActivityController(<span class="hljs-keyword">null</span>);
            }
        }

        <span class="hljs-keyword">long</span> anrTime &#61; SystemClock.uptimeMillis();
        <span class="hljs-keyword">if</span> (ActivityManagerService.MONITOR_CPU_USAGE) {
            mService.updateCpuStatsNow();
        }

        <span class="hljs-comment">// Unless configured otherwise, swallow ANRs in background processes &amp; kill the process.</span>
        <span class="hljs-keyword">boolean</span> showBackground &#61; Settings.Secure.getInt(mContext.getContentResolver(),
                Settings.Secure.ANR_SHOW_BACKGROUND, <span class="hljs-number">0</span>) !&#61; <span class="hljs-number">0</span>;

        <span class="hljs-keyword">boolean</span> isSilentANR;

        <span class="hljs-keyword">synchronized</span> (mService) {
            <span class="hljs-comment">// PowerManager.reboot() can block for a long time, so ignore ANRs while shutting down.</span>
            <span class="hljs-keyword">if</span> (mService.mShuttingDown) {
                Slog.i(TAG, <span class="hljs-string">&#34;During shutdown skipping ANR: &#34;</span> &#43; app &#43; <span class="hljs-string">&#34; &#34;</span> &#43; annotation);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (app.notResponding) {
                Slog.i(TAG, <span class="hljs-string">&#34;Skipping duplicate ANR: &#34;</span> &#43; app &#43; <span class="hljs-string">&#34; &#34;</span> &#43; annotation);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (app.crashing) {
                Slog.i(TAG, <span class="hljs-string">&#34;Crashing app skipping ANR: &#34;</span> &#43; app &#43; <span class="hljs-string">&#34; &#34;</span> &#43; annotation);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (app.killedByAm) {
                Slog.i(TAG, <span class="hljs-string">&#34;App already killed by AM skipping ANR: &#34;</span> &#43; app &#43; <span class="hljs-string">&#34; &#34;</span> &#43; annotation);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (app.killed) {
                Slog.i(TAG, <span class="hljs-string">&#34;Skipping died app ANR: &#34;</span> &#43; app &#43; <span class="hljs-string">&#34; &#34;</span> &#43; annotation);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// In case we come through here for the same app before completing</span>
            <span class="hljs-comment">// this one, mark as anring now so we will bail out.</span>
            app.notResponding &#61; <span class="hljs-keyword">true</span>;

            <span class="hljs-comment">// Log the ANR to the event log.</span>
            EventLog.writeEvent(EventLogTags.AM_ANR, app.userId, app.pid,
                    app.processName, app.info.flags, annotation);

            <span class="hljs-comment">// Dump thread traces as quickly as we can, starting with &#34;interesting&#34; processes.</span>
            firstPids.add(app.pid);

            <span class="hljs-comment">// Don&#39;t dump other PIDs if it&#39;s a background ANR</span>
            isSilentANR &#61; !showBackground &amp;&amp; !isInterestingForBackgroundTraces(app);
            <span class="hljs-keyword">if</span> (!isSilentANR) {
                <span class="hljs-keyword">int</span> parentPid &#61; app.pid;
                <span class="hljs-keyword">if</span> (parent !&#61; <span class="hljs-keyword">null</span> &amp;&amp; parent.app !&#61; <span class="hljs-keyword">null</span> &amp;&amp; parent.app.pid &gt; <span class="hljs-number">0</span>) {
                    parentPid &#61; parent.app.pid;
                }
                <span class="hljs-keyword">if</span> (parentPid !&#61; app.pid) firstPids.add(parentPid);

                <span class="hljs-keyword">if</span> (MY_PID !&#61; app.pid &amp;&amp; MY_PID !&#61; parentPid) firstPids.add(MY_PID);

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i &#61; mService.mLruProcesses.size() - <span class="hljs-number">1</span>; i &gt;&#61; <span class="hljs-number">0</span>; i--) {
                    ProcessRecord r &#61; mService.mLruProcesses.get(i);
                    <span class="hljs-keyword">if</span> (r !&#61; <span class="hljs-keyword">null</span> &amp;&amp; r.thread !&#61; <span class="hljs-keyword">null</span>) {
                        <span class="hljs-keyword">int</span> pid &#61; r.pid;
                        <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span> &amp;&amp; pid !&#61; app.pid &amp;&amp; pid !&#61; parentPid &amp;&amp; pid !&#61; MY_PID) {
                            <span class="hljs-keyword">if</span> (r.persistent) {
                                firstPids.add(pid);
                                <span class="hljs-keyword">if</span> (DEBUG_ANR) Slog.i(TAG, <span class="hljs-string">&#34;Adding persistent proc: &#34;</span> &#43; r);
                            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r.treatLikeActivity) {
                                firstPids.add(pid);
                                <span class="hljs-keyword">if</span> (DEBUG_ANR) Slog.i(TAG, <span class="hljs-string">&#34;Adding likely IME: &#34;</span> &#43; r);
                            } <span class="hljs-keyword">else</span> {
                                lastPids.put(pid, Boolean.TRUE);
                                <span class="hljs-keyword">if</span> (DEBUG_ANR) Slog.i(TAG, <span class="hljs-string">&#34;Adding ANR proc: &#34;</span> &#43; r);
                            }
                        }
                    }
                }
            }
        }

        <span class="hljs-comment">//输出ANR异常Log</span>

        <span class="hljs-comment">// Log the ANR to the main log.</span>
        StringBuilder info &#61; <span class="hljs-keyword">new</span> StringBuilder();
        info.setLength(<span class="hljs-number">0</span>);
        <span class="hljs-comment">//ANR发生时的进程Name</span>
        info.append(<span class="hljs-string">&#34;ANR in &#34;</span>).append(app.processName);
        <span class="hljs-keyword">if</span> (activity !&#61; <span class="hljs-keyword">null</span> &amp;&amp; activity.shortComponentName !&#61; <span class="hljs-keyword">null</span>) {
            info.append(<span class="hljs-string">&#34; (&#34;</span>).append(activity.shortComponentName).append(<span class="hljs-string">&#34;)&#34;</span>);
        }
        info.append(<span class="hljs-string">&#34;\n&#34;</span>);
        <span class="hljs-comment">//进程ID</span>
        info.append(<span class="hljs-string">&#34;PID: &#34;</span>).append(app.pid).append(<span class="hljs-string">&#34;\n&#34;</span>);
        <span class="hljs-comment">//ANR发生的原因</span>
        <span class="hljs-keyword">if</span> (annotation !&#61; <span class="hljs-keyword">null</span>) {
            info.append(<span class="hljs-string">&#34;Reason: &#34;</span>).append(annotation).append(<span class="hljs-string">&#34;\n&#34;</span>);
        }
        <span class="hljs-keyword">if</span> (parent !&#61; <span class="hljs-keyword">null</span> &amp;&amp; parent !&#61; activity) {
            info.append(<span class="hljs-string">&#34;Parent: &#34;</span>).append(parent.shortComponentName).append(<span class="hljs-string">&#34;\n&#34;</span>);
        }

        ProcessCpuTracker processCpuTracker &#61; <span class="hljs-keyword">new</span> ProcessCpuTracker(<span class="hljs-keyword">true</span>);

        <span class="hljs-comment">// don&#39;t dump native PIDs for background ANRs unless it is the process of interest</span>
        String[] nativeProcs &#61; <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">if</span> (isSilentANR) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i &#61; <span class="hljs-number">0</span>; i &lt; NATIVE_STACKS_OF_INTEREST.length; i&#43;&#43;) {
                <span class="hljs-keyword">if</span> (NATIVE_STACKS_OF_INTEREST[i].equals(app.processName)) {
                    nativeProcs &#61; <span class="hljs-keyword">new</span> String[] { app.processName };
                    <span class="hljs-keyword">break</span>;
                }
            }
        } <span class="hljs-keyword">else</span> {
            nativeProcs &#61; NATIVE_STACKS_OF_INTEREST;
        }

        <span class="hljs-keyword">int</span>[] pids &#61; nativeProcs &#61;&#61; <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : Process.getPidsForCommands(nativeProcs);
        ArrayList&lt;Integer&gt; nativePids &#61; <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">if</span> (pids !&#61; <span class="hljs-keyword">null</span>) {
            nativePids &#61; <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;(pids.length);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : pids) {
                nativePids.add(i);
            }
        }

        <span class="hljs-comment">// For background ANRs, don&#39;t pass the ProcessCpuTracker to</span>
        <span class="hljs-comment">// avoid spending 1/2 second collecting stats to rank lastPids.</span>
        <span class="hljs-comment">//dump栈信息</span>
        File tracesFile &#61; mService.dumpStackTraces(<span class="hljs-keyword">true</span>, firstPids,
                                                   (isSilentANR) ? <span class="hljs-keyword">null</span> : processCpuTracker,
                                                   (isSilentANR) ? <span class="hljs-keyword">null</span> : lastPids,
                                                   nativePids);

        String cpuInfo &#61; <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">if</span> (ActivityManagerService.MONITOR_CPU_USAGE) {
            mService.updateCpuStatsNow();
            <span class="hljs-keyword">synchronized</span> (mService.mProcessCpuTracker) {
                <span class="hljs-comment">//各进程使用CPU情况</span>
                cpuInfo &#61; mService.mProcessCpuTracker.printCurrentState(anrTime);
            }
            <span class="hljs-comment">//CPU当前负载</span>
            info.append(processCpuTracker.printCurrentLoad());
            info.append(cpuInfo);
        }

        info.append(processCpuTracker.printCurrentState(anrTime));

        Slog.e(TAG, info.toString());
        <span class="hljs-keyword">if</span> (tracesFile &#61;&#61; <span class="hljs-keyword">null</span>) {
            <span class="hljs-comment">// There is no trace file, so dump (only) the alleged culprit&#39;s threads to the log</span>
            Process.sendSignal(app.pid, Process.SIGNAL_QUIT);
        }
        <span class="hljs-comment">//将anr信息添加到dropbox</span>
        mService.addErrorToDropBox(<span class="hljs-string">&#34;anr&#34;</span>, app, app.processName, activity, parent, annotation,
                cpuInfo, tracesFile, <span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">if</span> (mService.mController !&#61; <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 0 &#61;&#61; show dialog, 1 &#61; keep waiting, -1 &#61; kill process immediately</span>
                <span class="hljs-keyword">int</span> res &#61; mService.mController.appNotResponding(
                        app.processName, app.pid, info.toString());
                <span class="hljs-keyword">if</span> (res !&#61; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span> &amp;&amp; app.pid !&#61; MY_PID) {
                        app.kill(<span class="hljs-string">&#34;anr&#34;</span>, <span class="hljs-keyword">true</span>);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">synchronized</span> (mService) {
                            mService.mServices.scheduleServiceTimeoutLocked(app);
                        }
                    }
                    <span class="hljs-keyword">return</span>;
                }
            } <span class="hljs-keyword">catch</span> (RemoteException e) {
                mService.mController &#61; <span class="hljs-keyword">null</span>;
                Watchdog.getInstance().setActivityController(<span class="hljs-keyword">null</span>);
            }
        }

        <span class="hljs-keyword">synchronized</span> (mService) {
            mService.mBatteryStatsService.noteProcessAnr(app.processName, app.uid);

            <span class="hljs-keyword">if</span> (isSilentANR) {
                app.kill(<span class="hljs-string">&#34;bg anr&#34;</span>, <span class="hljs-keyword">true</span>);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// Set the app&#39;s notResponding state, and look up the errorReportReceiver</span>
            makeAppNotRespondingLocked(app,
                    activity !&#61; <span class="hljs-keyword">null</span> ? activity.shortComponentName : <span class="hljs-keyword">null</span>,
                    annotation !&#61; <span class="hljs-keyword">null</span> ? <span class="hljs-string">&#34;ANR &#34;</span> &#43; annotation : <span class="hljs-string">&#34;ANR&#34;</span>,
                    info.toString());

            <span class="hljs-comment">通过Handler消息机制弹出ANR对话框</span>
            <span class="hljs-comment">// Bring up the infamous App Not Responding dialog</span>
            Message msg &#61; Message.obtain();
            HashMap&lt;String, Object&gt; map &#61; <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();
            msg.what &#61; ActivityManagerService.SHOW_NOT_RESPONDING_UI_MSG;
            msg.obj &#61; map;
            msg.arg1 &#61; aboveSystem ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
            map.put(<span class="hljs-string">&#34;app&#34;</span>, app);
            <span class="hljs-keyword">if</span> (activity !&#61; <span class="hljs-keyword">null</span>) {
                map.put(<span class="hljs-string">&#34;activity&#34;</span>, activity);
            }

            mService.mUiHandler.sendMessage(msg);
        }
    }
</code></pre> 
<p>Android中的ANR监测以Handler消息机制实现&#xff0c;使用观察者模式&#xff0c;当开始监测时注册消息&#xff08;该消息在规定时间后执行&#xff09;&#xff0c;事件处理完之后移除消息&#xff0c;当该消息执行时说明事件处理超过了规定的时间&#xff0c;即ANR。</p> 
<p><strong>6.总结</strong></p> 
<p>当ANR发生时&#xff0c;我们可以先通过logcat定位ANR的类型&#xff0c;然后通过trace信息分析产生ANR的原因&#xff0c;需要重点关注主线程&#xff08;main&#xff09;的当前状态和CPU的使用情况&#xff01;当然ANR还是以预防为主&#xff0c;切记不要在主线程做耗时操作&#xff0c;不管是主动发起还是调用系统方法都需要对耗时的地方进行评估&#xff01;</p>
                </div>
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-d7a94ec6ab.css" rel="stylesheet">
                <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-49037e4d27.css" rel="stylesheet">
        </div>
    </article>